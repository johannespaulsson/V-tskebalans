<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vätskebalans IVA Skövde</title>
    <!-- Länkar till Font Awesome för ikoner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h2>Patientinformation</h2>
        <div class="grid-container">
            <!-- Datumfält -->
            <div class="grid-item">
                <label for="dateInput">Datum:</label>
                <input type="date" id="dateInput">
            </div>
            <!-- Starttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="startTime">Beräknat från (starttid):</label>
                <div class="input-group">
                    <input type="time" id="startTime" value="06:00">
                    <button data-action="setNow" data-target="startTime">Nu</button>
                </div>
            </div>
            <!-- Sluttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="endTime">till (sluttid):</label>
                <div class="input-group">
                    <input type="time" id="endTime" value="06:00">
                    <button data-action="setNow" data-target="endTime">Nu</button>
                </div>
            </div>
            <!-- Sängval och "Annan plats" fält -->
            <div class="grid-item">
                <label for="bedSelect">Säng:</label>
                <select id="bedSelect">
                    <option value="">Välj säng</option>
                    <option value="IVA 1">IVA 1</option>
                    <option value="IVA 2">IVA 2</option>
                    <option value="IVA 3">IVA 3</option>
                    <option value="IVA 4">IVA 4</option>
                    <option value="IVA 5">IVA 5</option>
                    <option value="IVA 6">IVA 6</option>
                    <option value="IVA 7">IVA 7</option>
                    <option value="IVA 8">IVA 8</option>
                    <option value="IVA 9">IVA 9</option>
                    <option value="IVA 10">IVA 10</option>
                    <option value="IVA 11">IVA 11</option>
                    <option value="IVA 12">IVA 12</option>
                    <option value="IMA 1">IMA 1</option>
                    <option value="IMA 2">IMA 2</option>
                    <option value="IMA 3">IMA 3</option>
                    <option value="IMA 4">IMA 4</option>
                    <option value="Annan plats">Annan plats</option>
                </select>
                <input type="text" id="otherLocationInput" placeholder="Ange annan plats" style="display: none;">
            </div>
            <!-- Utgångsvikt/torrvikt -->
            <div class="grid-item">
                <label for="initialWeight">Utgångsvikt/torrvikt (kg):</label>
                <input type="text" id="initialWeight" class="important-input" placeholder="t.ex. 70.0">
            </div>
            <!-- Dagens vikt -->
            <div class="grid-item">
                <label for="dailyWeight">Dagens vikt (kg):</label>
                <input type="text" id="dailyWeight" class="important-input" placeholder="t.ex. 71.5" value="0">
            </div>
            <!-- Längd -->
            <div class="grid-item">
                <label for="height">Längd (cm):</label>
                <input type="text" id="height" class="important-input" placeholder="t.ex. 175.0">
            </div>
            <!-- Kön -->
            <div class="grid-item">
                <label for="gender">Kön:</label>
                <select id="gender" class="important-input">
                    <option value="">Välj kön</option>
                    <option value="Man">Man</option>
                    <option value="Kvinna">Kvinna</option>
                </select>
            </div>
            <!-- Nytt fält för Ålder -->
            <div class="grid-item">
                <label for="age">Ålder (år):</label>
                <input type="text" id="age" class="important-input" placeholder="t.ex. 40">
            </div>
            <!-- Idealvikt (kg) -->
            <div class="grid-item">
                <label for="idealWeight">Idealvikt (kg):</label>
                <input type="text" id="idealWeight" readonly class="calculated-output" value="Var god ange längd och kön">
                <span id="adjustedWeightNotice" class="adjusted-weight-notice" style="display: none;">(Justerad vikt)</span>
            </div>
            <!-- Kumulativ balans föregående dygn -->
            <div class="grid-item">
                <label for="cumulativeBalancePrev">Kumulativ balans föregående dygn (ml):</label>
                <input type="text" id="cumulativeBalancePrev" value="0">
            </div>
            <!-- Antal förfyllda 10ml NaCl-sprutor med +/- knappar -->
            <div class="grid-item">
                <label for="naclSyringes">Antal förfyllda 10ml NaCl-sprutor:</label>
                <div class="number-input-buttons">
                    <button data-action="changeNumber" data-target="naclSyringes" data-delta="-1"><i class="fas fa-minus"></i></button>
                    <input type="text" id="naclSyringes" value="0">
                    <button data-action="changeNumber" data-target="naclSyringes" data-delta="1"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <!-- Antal tryckset med +/- knappar -->
            <div class="grid-item">
                <label for="pressureSets">Antal tryckset (CVP-set = 2):</label>
                <div class="number-input-buttons">
                    <button data-action="changeNumber" data-target="pressureSets" data-delta="-1"><i class="fas fa-minus"></i></button>
                    <input type="text" id="pressureSets" value="0">
                    <button data-action="changeNumber" data-target="pressureSets" data-delta="1"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ny sektion för Balansräkning -->
    <div class="container" style="margin-top: 8px;">
        <h2>Balansräkning</h2>
        <div class="grid-container two-column-grid">
            <!-- Första kolumn: Kristalloider/Kolloider -->
            <div class="grid-column-item">
                <h3>Kristalloider/Kolloider</h3>
                <!-- Tabellrubriker för vätskeraderna -->
                <div class="fluid-table-header">
                    <div>Vätska</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="fluidEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addFluidButton" data-action="addRow" data-type="fluid" class="add-button">Lägg till vätska</button>
            </div>

            <!-- Andra kolumn: Läkemedelsvätskor -->
            <div class="grid-column-item">
                <h3>Läkemedelsvätskor</h3>
                <!-- Tabellrubriker för läkemedelsvätskeraderna -->
                <div class="fluid-table-header">
                    <div>Läkemedel</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="medicineEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addMedicineButton" data-action="addRow" data-type="medicine" class="add-button">Lägg till läkemedelsvätska</button>
            </div>

            <!-- Ny kolumn: Blodprodukter -->
            <div class="grid-column-item">
                <h3>Blodprodukter</h3>
                <div class="blood-product-table-header"> <!-- Specifik header för blodprodukter -->
                    <div>Blodprodukt</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="bloodProductEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addBloodProductButton" data-action="addRow" data-type="bloodProduct" class="add-button">Lägg till blodprodukt</button>
            </div>

            <!-- Ny kolumn: TPN/Sondmat/Peroralt -->
            <div class="grid-column-item">
                <h3>TPN/Sondmat/Peroralt</h3>
                <div class="tpn-sondmat-table-header"> <!-- Specifik header för TPN/Sondmat -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="tpnSondmatEntriesContainer">
                    <!-- Rader läggs till här dynamiskt -->
                </div>
                <button id="addTpnSondmatButton" data-action="addRow" data-type="tpnSondmat" class="add-button">Lägg till TPN/Sondmat/Peroralt</button>
            </div>

            <!-- Ny kolumn: Förluster -->
            <div class="grid-column-item">
                <h3>Förluster</h3>
                <div class="loss-table-header"> <!-- Specifik header för Förluster -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="lossEntriesContainer">
                    <!-- Statisk, icke-borttagningsbar Perspiratio-rad -->
                    <div class="loss-entry-row" data-id="perspiratio_static">
                        <div class="grid-item">
                            <!-- Hardcode the option for "Perspiratio" as it's static and disabled -->
                            <select id="lossSelect_perspiratio_static" disabled>
                                <option value="Perspiratio" selected disabled>Perspiratio</option>
                            </select>
                            <!-- Ingen custom input behövs för Perspiratio -->
                        </div>
                        <div class="grid-item">
                            <input type="text" id="lossMlInput_perspiratio_static" value="0">
                        </div>
                        <!-- Ingen ta bort-knapp för denna rad -->
                        <button class="remove-fluid-button disabled" disabled><i class="fas fa-trash"></i></button>
                    </div>
                    <!-- Dynamiska rader läggs till här -->
                </div>
                <button id="addLossButton" data-action="addRow" data-type="loss" class="add-button">Lägg till förlust</button>
            </div>

            <!-- Ny kolumn: Perspiratio-beräkning -->
            <div class="grid-column-item">
                <h3>Perspiratio-beräkning</h3>
                <div class="grid-item">
                    <label for="breathingSupport">Andningsstöd:</label>
                    <select id="breathingSupport">
                        <option value="standard">Standard/Inget</option>
                        <option value="niv_hmef">NIV med HMEF</option>
                        <option value="intub_hmef">Intuberad med HMEF</option>
                        <option value="niv_humid">NIV med aktiv befuktning</option>
                        <option value="hfnc">HFNC</option>
                        <option value="intub_humid">Intuberad med aktiv befuktning</option>
                    </select>
                </div>
                <div class="grid-item">
                    <label for="maxTemp">Maxtemperatur under dygnet (°C):</label>
                    <input type="text" id="maxTemp" value="37.0" placeholder="t.ex. 38.5">
                </div>
                <div class="grid-item">
                    <label id="calculatedPerspiratioLabel" for="calculatedPerspiratio">Beräknad Perspiratio (ml):</label>
                    <div class="calculated-perspiratio-group"> <!-- Ny flex-container för input och knapp -->
                        <input type="text" id="calculatedPerspiratio" readonly class="calculated-output" value="0">
                        <button id="transferPerspiratioButton" data-action="transferPerspiratio" class="add-button">För över till förlust</button>
                    </div>
                    <span id="perspiratioWarning"></span>
                </div>
            </div>

            <!-- NY KOLUMN: Verktyg -->
            <div class="grid-column-item">
                <h3>Verktyg</h3>
                <!-- Alla knappar får samma gröna färg genom add-button klassen -->
                <button id="openDiuresisCalculatorButton" data-action="openModal" data-target="diuresisCalculatorModalOverlay" class="add-button" style="margin-top: 0;">Diureskalkylator</button>
                <button id="openCalculationsButton" data-action="openModal" data-target="calculationsModalOverlay" class="add-button">Beräkningar & Referensvärden</button>
                <button id="openPrintSummaryButton" data-action="openModal" data-target="printDetailedSummaryModalOverlay" class="add-button">Skriv ut detaljerad sammanställning</button>
                <!-- Nya knappar för Spara/Ladda -->
                <div class="file-buttons-group">
                    <button id="saveToFileButton" data-action="save" class="add-button">Spara till fil</button>
                    <input type="file" id="loadFromFileInput" style="display: none;" accept=".json">
                    <button id="loadFromFileButton" data-action="load" class="add-button">Ladda från fil</button>
                </div>
            </div>

            <!-- NY KOLUMN: Sammanställning -->
            <div class="grid-column-item">
                <h3>Sammanställning</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding: 4px; border-bottom: 1px solid #ddd;">Post</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Volym (ml)</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Kcal</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td style="padding: 4px;">Totalt intag</td>
                            <td id="totalIntakeMl" style="text-align:right; padding: 4px;">0</td>
                            <td id="totalIntakeKcal" style="text-align:right; padding: 4px;">0</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Totalt förlust</td>
                            <td id="totalLossMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px; font-weight: bold;">Netto balans</td>
                            <td id="netBalanceMl" style="text-align:right; padding: 4px; font-weight: bold;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Kumulativ balans</td>
                            <td id="cumulativeBalanceMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Differens mot utgångsvikt (kg)</td>
                            <td id="weightDifferenceKg" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <!-- Ny rad för timdiures -->
                        <tr>
                            <td style="padding: 4px;">Genomsnittlig timdiures (ml/kg/h)</td>
                            <td id="avgHourlyDiuresis" style="text-align:right; padding: 4px;">0.00</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal för Beräkningar & Referensvärden -->
    <div id="calculationsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="calculationsModalOverlay">×</button>
            <h2>Beräkningar & Referensvärden</h2>
            <p style="font-size: 0.85rem; margin-bottom: 10px;">Kalorier beräknas genom att multiplicera den angivna <strong>mängden (ml)</strong> med ett specifikt <strong>kcal/ml-värde</strong> för respektive vätska/produkt. Värden för "Övrig vätska", "Övrigt läkemedel" och "Sondmat övrig" är 0 kcal/ml som standard om inget annat anges.</p>
            <!-- New class for modal's inner grid to handle 3 columns -->
            <div class="grid-container modal-three-column-grid">
                <div class="grid-column-item">
                    <h3>Perspiratioberäkning</h3>
                    <p>Perspiratio beräknas utifrån en fast grundförlust per dygn som justeras med en temperaturfaktor. Det slutgiltiga värdet anpassas till den valda tidsperioden.</p>
                    <p><strong>Grundförlust (per 24 timmar):</strong></p>
                    <ul>
                        <li><strong>700 ml:</strong> Standard (Inget andningsstöd, NIV/HMEF, Intuberad/HMEF)</li>
                        <li><strong>500 ml:</strong> Vid viss befuktning (NIV/aktiv befuktning, HFNC)</li>
                        <li><strong>400 ml:</strong> Vid optimal befuktning (Intuberad/aktiv befuktning)</li>
                    </ul>
                    <p><strong>Temperaturjustering:</strong><br>Beräkningen baseras på patientens maxtemperatur under dygnet. En faktor beräknas enligt `1 + (Maxtemp - 37) * 0.25`. Vid extrem kroppstemperatur används en fast faktor (0.5 vid &lt;35°C och 2.0 vid &gt;41°C).</p>
                    <p><strong>Gränsvärden:</strong><br>Beräkning sker ej om patientens ålder är under 15 år eller vikt är under 50 kg. Perspiratio sätts då till 0 ml.</p>
                </div>
                <div class="grid-column-item">
                    <h3>Idealvikt & Justerad Idealvikt</h3>
                    <p><strong>Idealvikt (Devine-formeln):</strong></p>
                    <ul>
                        <li><strong>Män:</strong> 50 + 0.91 x (Längd i cm - 152.4)</li>
                        <li><strong>Kvinnor:</strong> 45.5 + 0.91 x (Längd i cm - 152.4)</li>
                    </ul>
                    <p><strong>Justerad Idealvikt:</strong> Används om patientens dagliga vikt överstiger den beräknade idealvikten med mer än 20%.</p>
                    <ul>
                        <li>Justerad vikt = Idealvikt + 0.4 * (Aktuell vikt - Idealvikt)</li>
                    </ul>
                    <p><em>Alla vikter avrundas till en decimal.</em></p>
                </div>
                <!-- Nya Kcal-sektioner -->
                <div class="grid-column-item" id="kcalKristalloiderContainer"></div>
                <div class="grid-column-item" id="kcalMedicineContainer"></div>
                <div class="grid-column-item" id="kcalTpnSondmatContainer"></div>
            </div>
        </div>
    </div>

    <!-- START Diureskalkylator Modal -->
    <div id="diuresisCalculatorModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="diuresisCalculatorModalOverlay">×</button>
            <h2>Diureskalkylator</h2>

            <!-- Instruktionsavsnitt -->
            <div class="grid-column-item" style="margin-bottom: 15px;">
                <h3>Instruktioner</h3>
                <p style="font-size: 0.8rem;">
                    Fyll i relevanta vätsketillförslar och vätskeförluster i <strong>huvudfliken</strong>.<br>
                    Fyll in önskad vätskebalans fram till kl 06:00 nästa dygn i detta avsnitt.<br>
                    Fyll in planerade framtida tillförslar/förluster i detta avsnitt.
                </p>
            </div>

            <div class="grid-container two-column-diuresis">
                <!-- Vänster kolumn: Grundläggande inställningar & mål + Aktuell balans (nuvarande tidpunkt) -->
                <div class="grid-column-item">
                    <h3>Grundläggande inställningar & mål</h3>
                    <div class="grid-item">
                        <label for="desiredBalanceTomorrow">Önskad vätskebalans (ml) fram till klockan 06:00 nästa dygn:</label>
                        <input type="text" id="desiredBalanceTomorrow" value="0" placeholder="t.ex. 0 eller =100+50">
                    </div>
                    <div class="grid-item">
                        <label for="diuresisCalcTime">Beräkning från klockslag:</label>
                        <div class="input-group">
                            <input type="time" id="diuresisCalcTime">
                            <button data-action="setNow" data-target="diuresisCalcTime">Nu</button>
                        </div>
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Tidpunkt du gör din beräkning.</p>
                    </div>
                </div>

                <!-- Höger kolumn: Planerad framtida balans -->
                <div class="grid-column-item">
                    <h3>Planerad framtida balans (från 'Beräkning från' till 06:00 nästa dygn)</h3>
                    <div class="grid-item">
                        <label for="remainingTimeTo0600">Tid kvar till 06:00 (timmar):</label>
                        <input type="text" id="remainingTimeTo0600" readonly class="calculated-output">
                    </div>
                    <div class="grid-item">
                        <label for="expectedPerspiratioRemaining">Förväntad Perspiratio (återstående till 06:00) (ml):</label>
                        <input type="text" id="expectedPerspiratioRemaining" readonly class="calculated-output">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Baseras på vikt och den aktuella feberjusteringsgraden från huvudfliken.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleIntake">Förväntad vätsketillförsel (engångsdoser) (ml):</label>
                        <input type="text" id="plannedSingleIntake" value="0" placeholder="t.ex. 0 eller =100+50">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade enstaka infusioner/vätskor.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedHourlyIntake">Förväntad vätsketillförsel per timma (ml/h):</label>
                        <input type="text" id="plannedHourlyIntake" value="0" placeholder="t.ex. 0 eller =100+50">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Kontinuerliga dropp (ex. Propofol, Noradrenalin).</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleLosses">Förväntade övriga förluster (engångsförluster) (ml):</label>
                        <input type="text" id="plannedSingleLosses" value="0" placeholder="t.ex. 0 eller =100+50">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade/förväntade enstaka förluster.</p>
                    </div>
                </div>
            </div>

            <!-- Resultat och Diuresbehov -->
            <div class="grid-column-item" style="margin-top: 15px;">
                <h3>Resultat och Diuresbehov</h3>
                <table class="diuresis-summary-table" style="width:100%; border-collapse: collapse;">
                    <tbody>
                        <tr>
                            <td colspan="2" class="category-heading">Aktuella Värden (från Huvudflik)</td>
                        </tr>
                        <tr>
                            <td>Aktuell vätskebalans (ml)</td>
                            <td id="summaryBalanceTillNow" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Planerade Framtida Värden (från nu till 06:00 nästa dygn)</td>
                        </tr>
                        <tr>
                            <td>Tid kvar till 06:00 (timmar)</td>
                            <td id="summaryRemainingHoursFuture" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad engångstillförsel (ml)</td>
                            <td id="summaryPlannedSingleIntakeSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Total förväntad kontinuerlig tillförsel (<span id="plannedHourlyIntakeDisplay">0</span> ml/h x <span id="remainingHoursDisplay">0</span> timmar)</td>
                            <td id="summaryPlannedHourlyIntakeTotal" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntade engångsförluster (ml)</td>
                            <td id="summaryPlannedSingleLossesSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad perspiratio (ml)</td>
                            <td id="summaryExpectedPerspiratioRemainingSummary" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Sammanställda Beräkningar & Diuresbehov</td>
                        </tr>
                        <tr>
                            <td>Önskad vätskebalans vid 06:00 nästa dygn (ml)</td>
                            <td id="summaryDesiredBalanceTomorrowSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknad total tillförsel (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedIntake" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknade totala förluster (exkl. Diures) (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedLossExclDiuresis" style="text-align:right;">0</td>
                        </tr>
                        <tr class="highlight-row">
                            <td>Diuresbehov per timma (för återstående tid) (ml/h)</td>
                            <td id="diuresisNeedPerHour" style="text-align:right;">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button data-action="closeModal" data-target="diuresisCalculatorModalOverlay" class="add-button" style="margin-top: 15px;">Tillbaka till Vätskebalans</button>
        </div>
    </div>
    <!-- END Diureskalkylator Modal -->

    <!-- START Detaljerad Sammanställning Modal -->
    <div id="printDetailedSummaryModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="printDetailedSummaryModalOverlay">×</button>
            <h2>Vätskebalansräkning</h2>

            <!-- Ruta för patientetikett -->
            <div class="patient-label-box">
                Plats för patientetikett
            </div>

            <!-- Allmän information om patient och tidsperiod -->
            <div class="summary-info">
                <p><strong>Datum:</strong> <span id="summaryDate"></span></p>
                <p><strong>Tidsperiod:</strong> <span id="summaryTimePeriod"></span></p>
                <p><strong>Plats:</strong> <span id="summaryLocation"></span></p>
            </div>

            <!-- Vikter -->
            <h3>Vikter</h3>
            <table class="summary-table">
                <tr>
                    <td>Utgångsvikt/torrvikt:</td>
                    <td id="printInitialWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Dagens vikt:</td>
                    <td id="printDailyWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Idealvikt (beräknad/justerad):</td>
                    <td id="printIdealWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Differens mot utgångsvikt:</td>
                    <td id="printWeightDifference" class="numeric-value"></td>
                </tr>
            </table>

            <!-- Vätskebalansberäkningar -->
            <h3>Vätskebalans</h3>
            <table class="summary-table">
                <tr>
                    <td>Totalt intag:</td>
                    <td id="printTotalIntakeMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Totalt förlust:</td>
                    <td id="printTotalLossMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Netto balans:</td>
                    <td id="printNetBalanceMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Kumulativ balans:</td>
                    <td id="printCumulativeBalanceMl" class="numeric-value"></td>
                </tr>
            </table>

            <!-- Läkemedelsvolymer (subkategoriserade) -->
            <h3>Läkemedelsvolymer (totalt)</h3>
            <table class="summary-table">
                <tr>
                    <td>Sedativa:</td>
                    <td id="printMedicineSedativeMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Antibiotika:</td>
                    <td id="printMedicineAntibioticsMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Vasoaktiva:</td>
                    <td id="printMedicineVasoactiveMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Övriga läkemedel:</td>
                    <td id="printMedicineOtherMl" class="numeric-value">0 ml</td>
                </tr>
            </table>

            <!-- Kcal-intag (uppdelat) -->
            <h3>Kcal-intag</h3>
            <table class="summary-table">
                <tr>
                    <td>Kcal från peroralt intag:</td>
                    <td id="printKcalPeroral" class="numeric-value">0 Kcal</td>
                </tr>
                <tr>
                    <td>Kcal från sondmat:</td>
                    <td id="printKcalSondmat" class="numeric-value">0 Kcal</td>
                </tr>
                <!-- Förenad rad för IV Läkemedel och TPN -->
                <tr>
                    <td>Kcal från intravenös tillförsel:</td>
                    <td id="printKcalIntravenousTotal" class="numeric-value">0 Kcal</td>
                </tr>
                <tr>
                    <td><strong>Totalt Kcal intag:</strong></td>
                    <td id="printTotalKcalIntake" class="numeric-value">0 Kcal</td>
                </tr>
            </table>

            <!-- Utskriftsknapp -->
            <button class="add-button" style="margin-top: 20px;" data-action="print">Skriv ut</button>
        </div>
    </div>
    <!-- END Detaljerad Sammanställning Modal -->

    <!-- Nytt: Modal för Ändringslogg -->
    <div id="changelogModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" data-action="closeModal" data-target="changelogModalOverlay">×</button>
            <h2>Ändringslogg / Versioner</h2>
            <h3>Version 1.3</h3>
            <ul>
                <li>Bytt beräkningsmodell för perspiratio till att baseras på en fast grundförlust per dygn som justeras med en temperaturfaktor.</li>
                <li>Lagt till fält för "Ålder" och "Maxtemperatur" för den nya beräkningen.</li>
                <li>Lagt till varningstext om perspiratio inte kan beräknas (ålder &lt;15 eller vikt &lt;50).</li>
                <li>Uppdaterat informationstexten under "Beräkningar & Referensvärden".</li>
            </ul>
            <h3>Version 1.2</h3>
            <ul>
                <li>Lade till "Blödning" som ett alternativ under "Förluster".</li>
            </ul>
            <h3>Version 1.1</h3>
            <ul>
                <li>Spara/Ladda-knapparna ligger nu bredvid varandra för en mer kompakt layout.</li>
                <li>Lade till denna ändringslogg för att visa versionshistorik.</li>
                <li>Gjorde fältet för Perspiratio under "Förluster" redigerbart för manuell justering.</li>
                <li>Tog bort exempeltext från fältet "Kumulativ balans".</li>
                <li>Korrigerade en bugg som hindrade färgindikeringen (röd/grön) på obligatoriska fält från att fungera korrekt.</li>
                <li>Korrigerade en bugg som gjorde att Kcal-fälten inte kunde redigeras manuellt.</li>
            </ul>
             <h3>Version 1.0</h3>
            <ul>
                <li>Initial version av applikationen.</li>
            </ul>
        </div>
    </div>

    <footer class="app-footer">
        <span class="changelog-link" data-action="openModal" data-target="changelogModalOverlay">
            Version 1.3 - Ändringslogg
        </span>
    </footer>

    <script>
        const app = {
            state: {
                totalIntakeMl: 0, totalIntakeKcal: 0, totalLossMl: 0, netBalanceMl: 0, cumulativeBalanceMl: 0,
                weightDifferenceKg: 0, totalDiuresisMl: 0, totalPerspiratioMl: 0, totalOtherLossMl: 0,
                dailyWeight: 0, height: 0, gender: '', age: 0, maxTemp: 37.0, breathingSupport: 'standard',
                mainAppStartTime: '06:00', mainAppEndTime: '06:00',
                patientDate: '', patientTimePeriod: '', patientLocation: '', initialWeight: 0, idealWeight: 0,
                adjustedWeight: false,
                avgHourlyDiuresis: 0,
                perspiratioWarning: '',
                medicineCategoryTotals: { Sedering: 0, Antibiotika: 0, Vasoaktiva: 0, Övrigt: 0 },
                kcalSummary: { peroralt: 0, sondmat: 0, tpn: 0, ivMedicine: 0, intravenousTotal: 0 }
            },
            counters: { fluid: 0, medicine: 0, bloodProduct: 0, tpnSondmat: 0, loss: 0 },
            config: {
                fluid: {
                    containerId: 'fluidEntriesContainer',
                    template: (id) => `<div class="fluid-entry-row" data-id="${id}" data-type="fluid"><div class="grid-item"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange övrig vätska" style="display: none;"></div><div class="grid-item"><input type="text" class="ml-input" value="0" placeholder="=50+50"></div><div class="grid-item"><input type="text" class="kcal-output" value="0" placeholder="=10*1.1"></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'fluid')
                },
                medicine: {
                    containerId: 'medicineEntriesContainer',
                    template: (id) => `<div class="fluid-entry-row" data-id="${id}" data-type="medicine"><div class="grid-item"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange övrigt läkemedel" style="display: none;"></div><div class="grid-item"><input type="text" class="ml-input" value="0" placeholder="=50+50"></div><div class="grid-item"><input type="text" class="kcal-output" value="0" placeholder="=10*1.1"></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'medicine')
                },
                bloodProduct: {
                    containerId: 'bloodProductEntriesContainer',
                    template: (id) => `<div class="blood-product-entry-row" data-id="${id}" data-type="bloodProduct"><div class="grid-item"><select class="select-main"></select></div><div class="grid-item"><input type="text" class="ml-input" value="0" placeholder="=50+50"></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'bloodProduct')
                },
                tpnSondmat: {
                    containerId: 'tpnSondmatEntriesContainer',
                    template: (id) => `<div class="tpn-sondmat-entry-row" data-id="${id}" data-type="tpnSondmat"><div class="grid-item"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange övrig sondmat" style="display: none;"></div><div class="grid-item"><input type="text" class="ml-input" value="0" placeholder="=50+50"></div><div class="grid-item"><input type="text" class="kcal-output" value="0" placeholder="=10*1.1"></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'tpnSondmat')
                },
                loss: {
                    containerId: 'lossEntriesContainer',
                    template: (id) => `<div class="loss-entry-row" data-id="${id}" data-type="loss"><div class="grid-item"><select class="select-main"></select><input type="text" class="custom-input" placeholder="Ange annan förlust" style="display: none;"></div><div class="grid-item"><input type="text" class="ml-input" value="0" placeholder="=50+50"></div><button class="remove-fluid-button" data-action="removeRow"><i class="fas fa-trash"></i></button></div>`,
                    populateSelect: (select) => app.populateSelect(select, 'loss')
                }
            },
            data: {
                fluid: {
                    placeholder: 'Välj vätska', customOption: 'Övrig vätska',
                    categories: {
                        "Glucos utan elektrolyter": [{ name: "Glukos 25 mg/ml", kcal: 0.1 }, { name: "Glukos 50 mg/ml", kcal: 0.2 }, { name: "Glukos 100 mg/ml", kcal: 0.4 }, { name: "Glukos 200 mg/ml", kcal: 0.8 }, { name: "Glukos 300 mg/ml", kcal: 1.2 }],
                        "Kolloider": [{ name: "Albumin 20%", kcal: 0.8 }, { name: "Albumin 5%", kcal: 0 }],
                        "Kristalloider med elektrolyter": [{ name: "Glukos 100 mg/ml med el", kcal: 0.4 }, { name: "Glukos 50 mg/ml med El", kcal: 0.2 }, { name: "NaCl Picco-Kalibrering", kcal: 0 }, { name: "Natriumbikarbonat 50 mg/ml", kcal: 0 }, { name: "Natriumklorid 9 mg/ml", kcal: 0 }, { name: "Natriumklorid hyperton", kcal: 0 }, { name: "Plasmolyte", kcal: 0 }, { name: "Ringer-Acetat", kcal: 0 }]
                    }
                },
                medicine: {
                    placeholder: 'Välj läkemedelsvätska', customOption: 'Övrigt läkemedel', customOption2: 'Övrig Antibiotika',
                    categories: {
                        "Sedering": [{ name: "Dexdor", kcal: 0 }, { name: "Esketamin", kcal: 0 }, { name: "Klonidin", kcal: 0 }, { name: "Midazolam", kcal: 0 }, { name: "Propofol 10mg/ml", kcal: 1.1 }, { name: "Propofol 20mg/ml", kcal: 1.33 }, { name: "Remifentanil", kcal: 0 }],
                        "Antibiotika": [{ name: "Pip/Taz 4g x 3", kcal: 0, defaultMl: 60 }, { name: "Övrig Antibiotika", kcal: 0 }, { name: "Kaspofungin", kcal: 0, defaultMl: 250 }],
                        "Vasoaktiva": [{ name: "Adrenalin", kcal: 0 }, { name: "Argipressin", kcal: 0 }, { name: "Dobutamin", kcal: 0 }, { name: "Levosimendan", kcal: 0.2 }, { name: "Milrinon", kcal: 0 }, { name: "Noradrenalin", kcal: 0 }],
                        "Övrigt": [{ name: "Amiodarone", kcal: 0.2 }, { name: "EDA", kcal: 0 }, { name: "Lispro", kcal: 0 }, { name: "Paracetamol", kcal: 0 }]
                    }
                },
                bloodProduct: { placeholder: 'Välj blodprodukt', options: ['Erytrocyter', 'Trombocyter', 'Plasma'] },
                tpnSondmat: {
                    placeholder: 'Välj TPN/Sondmat/Peroralt', customOption: 'Sondmat övrig',
                    options: [{ name: "Peroralt intag", kcal: 0 }],
                    categories: {
                        "TPN/Sondmat": [{ name: "Vatten i sond", kcal: 0 }, { name: "Sondmat övrig", kcal: 0 }, { name: "Smof Kabiven 900 kcal extra nitrogen", kcal: 0.9 }, { name: "Smof Kabiven 1100 kcal", kcal: 1.12 }, { name: "Smof Kabiven PI 1300 kcal", kcal: 0.68 }, { name: "Smof Kabiven 1350 kcal extra nitrogen", kcal: 0.9 }, { name: "Smof Kabiven 1600 kcal", kcal: 1.08 }, { name: "Smof Kabiven 1800 extra nitrogen", kcal: 1.1 }, { name: "Smof Kabiven 2200 kcal", kcal: 1.12 }, { name: "Sondmat Fresubin 2 kcal HP", kcal: 2.0 }, { name: "Sondmat Fresubin Original", kcal: 1 }, { name: "Sondmat Isosource standardfibre", kcal: 1 }]
                    }
                },
                loss: { placeholder: 'Välj förlusttyp', customOption: 'Annan förlust', options: ['Avföring', 'Blödning', 'Dialys (CRRT)', 'Dialys (IHD)', 'Diures', 'Drän 1', 'Drän 2', 'Drän 3', 'Sond', 'Stomi', 'Thoraxdrän hö', 'Thoraxdrän vä'] }
            },
            init() {
                this.cacheDOMElements();
                this.bindEvents();
                this.setDefaultValues();
                this.addInitialRows();
                this.checkInitialInputColors();
                this.updateAllCalculations();
            },
            cacheDOMElements() {
                this.dom = {
                    body: document.body,
                    dateInput: document.getElementById('dateInput'),
                    otherLocationInput: document.getElementById('otherLocationInput'),
                    loadFromFileInput: document.getElementById('loadFromFileInput'),
                    perspiratioWarning: document.getElementById('perspiratioWarning'),
                    containers: {
                        fluid: document.getElementById('fluidEntriesContainer'),
                        medicine: document.getElementById('medicineEntriesContainer'),
                        bloodProduct: document.getElementById('bloodProductEntriesContainer'),
                        tpnSondmat: document.getElementById('tpnSondmatEntriesContainer'),
                        loss: document.getElementById('lossEntriesContainer'),
                    },
                    summary: {
                        totalIntakeMl: document.getElementById('totalIntakeMl'),
                        totalIntakeKcal: document.getElementById('totalIntakeKcal'),
                        totalLossMl: document.getElementById('totalLossMl'),
                        netBalanceMl: document.getElementById('netBalanceMl'),
                        cumulativeBalanceMl: document.getElementById('cumulativeBalanceMl'),
                        weightDifferenceKg: document.getElementById('weightDifferenceKg'),
                        avgHourlyDiuresis: document.getElementById('avgHourlyDiuresis'),
                    }
                };
            },
            setDefaultValues() {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                this.dom.dateInput.value = yesterday.toISOString().split('T')[0];
            },
            addInitialRows() {
                ['fluid', 'medicine', 'bloodProduct', 'tpnSondmat', 'loss'].forEach(type => this.addRow(type, { isInitial: true }));
            },
            checkInitialInputColors() {
                document.querySelectorAll('.important-input, .filled-input').forEach(input => {
                    this.updateInputColor(input);
                });
            },
            updateInputColor(inputElement) {
                const hasValue = inputElement.value.trim() !== '' && (inputElement.id !== 'dailyWeight' || inputElement.value.trim() !== '0');
                if (hasValue) {
                    inputElement.classList.add('filled-input');
                    inputElement.classList.remove('important-input');
                } else {
                    inputElement.classList.remove('filled-input');
                    inputElement.classList.add('important-input');
                }
            },
            bindEvents() {
                this.dom.body.addEventListener('click', this.handleDelegatedClick.bind(this));
                const mainContent = document.querySelector('body');
                mainContent.addEventListener('input', this.handleFormInput.bind(this));
                mainContent.addEventListener('change', this.handleFormInput.bind(this));
                mainContent.addEventListener('blur', (e) => {
                    if (e.target.matches('input[type="text"]')) this.handleFormulaInput(e);
                }, true);
                mainContent.addEventListener('keydown', (e) => {
                    if (e.target.matches('input[type="text"]') && e.key === 'Enter') {
                        e.preventDefault();
                        this.handleFormulaInput(e);
                        e.target.blur();
                    }
                });
                this.dom.loadFromFileInput.addEventListener('change', this.loadDataFromFile.bind(this));
            },
            handleDelegatedClick(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action, target: targetId, delta, type } = target.dataset;
                switch (action) {
                    case 'setNow': this.setNow(targetId); break;
                    case 'changeNumber': this.changeNumber(targetId, parseInt(delta, 10)); break;
                    case 'addRow': this.addRow(type); break;
                    case 'removeRow':
                        target.closest('[data-id]').remove();
                        this.updateAllCalculations();
                        break;
                    case 'transferPerspiratio': this.transferPerspiratioToLoss(); break;
                    case 'openModal': this.openModal(targetId); break;
                    case 'closeModal': this.closeModal(targetId); break;
                    case 'save': this.saveDataToFile(); break;
                    case 'load': this.dom.loadFromFileInput.click(); break;
                    case 'print': window.print(); break;
                }
            },
            handleFormInput(e) {
                const target = e.target;
                if (target.matches('.important-input, .filled-input')) {
                    this.updateInputColor(target);
                }
                if (target.id === 'bedSelect') {
                    this.dom.otherLocationInput.style.display = target.value === 'Annan plats' ? 'block' : 'none';
                }
                const row = target.closest('[data-id]');
                if (row) {
                    const kcalOutput = row.querySelector('.kcal-output');
                    if (kcalOutput) {
                        if (target.classList.contains('kcal-output')) {
                            kcalOutput.dataset.manualOverride = 'true';
                        } else if (target.classList.contains('select-main') || target.classList.contains('ml-input')) {
                            kcalOutput.dataset.manualOverride = 'false';
                        }
                    }
                    if (target.classList.contains('select-main')) {
                        const customInput = row.querySelector('.custom-input');
                        if (customInput) {
                            const configData = this.data[row.dataset.type];
                            const showCustom = target.value === configData.customOption || (configData.customOption2 && target.value === configData.customOption2);
                            customInput.style.display = showCustom ? 'block' : 'none';
                        }
                    }
                }
                this.updateAllCalculations();
            },
            handleFormulaInput(event) {
                const input = event.target;
                let value = input.value.trim();
                if (!value.startsWith('=')) return;
                const expression = value.substring(1);
                if (expression === '') return;
                try {
                    if (!/^[0-9+\-*/().\s]+$/.test(expression)) {
                        console.warn(`Invalid characters in formula: "${expression}"`);
                        return;
                    }
                    const result = new Function(`return ${expression}`)();
                    if (typeof result === 'number' && !isNaN(result)) {
                        input.value = Math.round(result);
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } catch (e) {
                    console.error(`Error evaluating formula: "${expression}"`, e);
                }
            },
            addRow(type, initialData = {}) {
                const config = this.config[type];
                if (!config) return;
                this.counters[type]++;
                const id = `${type}_${this.counters[type]}`;
                const container = this.dom.containers[type];
                container.insertAdjacentHTML('beforeend', config.template(id));
                const newRow = container.querySelector(`[data-id="${id}"]`);
                const select = newRow.querySelector('.select-main');
                if (select && config.populateSelect) {
                    config.populateSelect(select);
                }
                if (Object.keys(initialData).length > 0 && !initialData.isInitial) {
                    if(select) select.value = initialData.selectValue || '';
                    newRow.querySelector('.ml-input').value = initialData.mlValue || '0';
                    if(newRow.querySelector('.kcal-output')) newRow.querySelector('.kcal-output').value = initialData.kcalValue || '0';
                    if(newRow.querySelector('.custom-input')) {
                        const customInput = newRow.querySelector('.custom-input');
                        customInput.value = initialData.customValue || '';
                        const showCustom = select.value === this.data[type].customOption || (this.data[type].customOption2 && select.value === this.data[type].customOption2);
                        customInput.style.display = showCustom ? 'block' : 'none';
                    }
                }
                if(initialData.isInitial !== true) this.updateAllCalculations();
            },
            populateSelect(selectElement, type) {
                const configData = this.data[type];
                if (!configData) return;
                selectElement.innerHTML = '';
                this.addOption(selectElement, '', configData.placeholder);
                const addCustomOption = (optName) => {
                    if (!optName) return;
                    this.addOption(selectElement, optName, optName, 0);
                };
                addCustomOption(configData.customOption);
                addCustomOption(configData.customOption2);
                if (configData.options) {
                    configData.options.forEach(opt => {
                        if (typeof opt === 'object') this.addOption(selectElement, opt.name, opt.name, opt.kcal);
                        else this.addOption(selectElement, opt, opt);
                    });
                }
                if (configData.categories) {
                    for (const categoryLabel in configData.categories) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = categoryLabel;
                        configData.categories[categoryLabel].forEach(item => {
                            this.addOption(optgroup, item.name, item.name, item.kcal, item.defaultMl);
                        });
                        selectElement.appendChild(optgroup);
                    }
                }
            },
            addOption(parent, value, text, kcal = null, defaultMl = null) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (kcal !== null) option.dataset.kcalPerMl = kcal;
                if (defaultMl !== null) option.dataset.defaultMl = defaultMl;
                parent.appendChild(option);
            },
            updateAllCalculations() {
                this.calculateIdealAndAdjustedWeight();
                this.calculatePerspiratio();
                this.calculateTotals();
                this.calculateDiuresis();
                this.updateSummaryUI();
            },
            setNow(elementId) {
                const timeInput = document.getElementById(elementId);
                if (!timeInput) return;
                const now = new Date();
                timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                timeInput.dispatchEvent(new Event('input', { bubbles: true }));
            },
            changeNumber(elementId, delta) {
                const input = document.getElementById(elementId);
                if (!input) return;
                input.value = (parseFloat(input.value) || 0) + delta;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            },
            calculateDurationInHours(startTimeStr, endTimeStr) {
                try {
                    if (!startTimeStr || !endTimeStr) return 0;
                    const [startH, startM] = startTimeStr.split(':').map(Number);
                    const [endH, endM] = endTimeStr.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    let endMinutes = endH * 60 + endM;
                    if (startMinutes === endMinutes) return 24;
                    if (endMinutes < startMinutes) endMinutes += 24 * 60;
                    return (endMinutes - startMinutes) / 60;
                } catch (error) {
                    return 0;
                }
            },
            calculateIdealAndAdjustedWeight() {
                const height = parseFloat(document.getElementById('height').value);
                const gender = document.getElementById('gender').value;
                const dailyWeight = parseFloat(document.getElementById('dailyWeight').value);
                const idealWeightInput = document.getElementById('idealWeight');
                const notice = document.getElementById('adjustedWeightNotice');
                if (!idealWeightInput || !notice) return; // Guard clause
                if (!height || !gender) {
                    idealWeightInput.value = "Var god ange längd och kön";
                    notice.style.display = 'none';
                    return;
                }
                let idealWeight = (gender === 'Man') ? (50 + 0.91 * (height - 152.4)) : (45.5 + 0.91 * (height - 152.4));
                idealWeight = Math.round(idealWeight * 10) / 10;
                let displayWeight = idealWeight;
                let isAdjusted = false;
                if (dailyWeight > (idealWeight * 1.20)) {
                    displayWeight = idealWeight + 0.4 * (dailyWeight - idealWeight);
                    isAdjusted = true;
                }
                idealWeightInput.value = (Math.round(displayWeight * 10) / 10).toFixed(1);
                notice.style.display = isAdjusted ? 'inline' : 'none';
            },
            calculatePerspiratio() {
                const age = parseFloat(document.getElementById('age').value) || 0;
                const weight = parseFloat(document.getElementById('dailyWeight').value) || 0;
                const ventilationStatus = document.getElementById('breathingSupport').value;
                const temperature = parseFloat(document.getElementById('maxTemp').value) || 37.0;
                const outputEl = document.getElementById('calculatedPerspiratio');
                
                this.state.perspiratioWarning = ''; // Reset warning

                if (age < 15 && weight < 50) {
                    this.state.perspiratioWarning = "Ålder < 15 & vikt < 50 kg. Beräknas ej.";
                } else if (age < 15) {
                    this.state.perspiratioWarning = "Ålder < 15 år. Beräknas ej.";
                } else if (weight < 50) {
                    this.state.perspiratioWarning = "Vikt < 50 kg. Beräknas ej.";
                }

                if (this.state.perspiratioWarning) {
                    outputEl.value = '0 ml';
                    this.dom.perspiratioWarning.textContent = this.state.perspiratioWarning;
                    return;
                }

                let lBasicPerspiratio = 700;
                switch(ventilationStatus) {
                    case 'niv_humid':
                    case 'hfnc':
                        lBasicPerspiratio = 500;
                        break;
                    case 'intub_humid':
                        lBasicPerspiratio = 400;
                        break;
                }

                let sTempFactor = 1;
                const sTempDifference = temperature - 37;
                if (temperature < 35) { // Corresponds to < -2 difference
                    sTempFactor = 0.5;
                } else if (temperature > 41) { // Corresponds to > 4 difference
                    sTempFactor = 2;
                } else {
                    sTempFactor = 1 + (sTempDifference * 0.25);
                }

                const perspiratio24h = lBasicPerspiratio * sTempFactor;
                const duration = this.calculateDurationInHours(document.getElementById('startTime').value, document.getElementById('endTime').value);
                const finalPerspiratio = perspiratio24h * (duration / 24);

                outputEl.value = `${Math.round(finalPerspiratio)} ml`;
                this.dom.perspiratioWarning.textContent = '';
            },
            transferPerspiratioToLoss() {
                const perspiratioValue = parseFloat(document.getElementById('calculatedPerspiratio').value) || 0;
                document.getElementById('lossMlInput_perspiratio_static').value = perspiratioValue;
                this.updateAllCalculations();
            },
            calculateTotals() {
                this.state.dailyWeight = parseFloat(document.getElementById('dailyWeight').value) || 0;
                this.state.initialWeight = parseFloat(document.getElementById('initialWeight').value) || 0;

                Object.assign(this.state, {
                    totalIntakeMl: 0, totalIntakeKcal: 0, totalLossMl: 0,
                    medicineCategoryTotals: { Sedering: 0, Antibiotika: 0, Vasoaktiva: 0, Övrigt: 0 },
                    kcalSummary: { peroralt: 0, sondmat: 0, tpn: 0, ivMedicine: 0, intravenousTotal: 0 },
                    totalDiuresisMl: 0, totalPerspiratioMl: 0, totalOtherLossMl: 0
                });
                let kcalFromKristalloider = 0;
                document.querySelectorAll('[data-id]').forEach(row => {
                    const type = row.dataset.type;
                    if (!type) { // Handle static perspiratio row
                        if(row.querySelector('#lossMlInput_perspiratio_static')) {
                            const mlValue = parseFloat(row.querySelector('#lossMlInput_perspiratio_static').value) || 0;
                            this.state.totalLossMl += mlValue;
                            this.state.totalPerspiratioMl += mlValue;
                        }
                        return;
                    }
                    const mlInput = row.querySelector('.ml-input');
                    const mlValue = parseFloat(mlInput?.value) || 0;
                    const select = row.querySelector('.select-main');
                    const selectedOption = select?.options[select.selectedIndex];
                    const kcalOutput = row.querySelector('.kcal-output');
                    let kcalValue = 0;
                    if (kcalOutput && selectedOption) {
                        if (kcalOutput.dataset.manualOverride !== 'true') {
                            const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                            kcalValue = Math.round(mlValue * kcalPerMl);
                            kcalOutput.value = kcalValue;
                        } else {
                            kcalValue = parseFloat(kcalOutput.value) || 0;
                        }
                    }
                    if (['fluid', 'medicine', 'bloodProduct', 'tpnSondmat'].includes(type)) {
                        this.state.totalIntakeMl += mlValue;
                        this.state.totalIntakeKcal += kcalValue;
                    } else if (type === 'loss') {
                        this.state.totalLossMl += mlValue;
                        if (select?.value === 'Diures') this.state.totalDiuresisMl += mlValue;
                        else this.state.totalOtherLossMl += mlValue;
                    }
                    if (type === 'fluid') kcalFromKristalloider += kcalValue;
                    if (type === 'medicine') {
                        this.state.kcalSummary.ivMedicine += kcalValue;
                        const category = Object.keys(this.data.medicine.categories).find(cat => this.data.medicine.categories[cat].some(item => item.name === select.value)) || 'Övrigt';
                        this.state.medicineCategoryTotals[category] += mlValue;
                    }
                    if (type === 'tpnSondmat') {
                        if (select.value === 'Peroralt intag') this.state.kcalSummary.peroralt += kcalValue;
                        else if (select.value.startsWith('Sondmat') || select.value === 'Vatten i sond') this.state.kcalSummary.sondmat += kcalValue;
                        else this.state.kcalSummary.tpn += kcalValue;
                    }
                });
                const naclSyringes = parseFloat(document.getElementById('naclSyringes').value) || 0;
                this.state.totalIntakeMl += naclSyringes * 10;
                const pressureSets = parseFloat(document.getElementById('pressureSets').value) || 0;
                const duration = this.calculateDurationInHours(document.getElementById('startTime').value, document.getElementById('endTime').value);
                this.state.totalIntakeMl += pressureSets * 3 * duration;
                this.state.netBalanceMl = this.state.totalIntakeMl - this.state.totalLossMl;
                const cumulativePrev = parseFloat(document.getElementById('cumulativeBalancePrev').value) || 0;
                this.state.cumulativeBalanceMl = cumulativePrev + this.state.netBalanceMl;
                this.state.weightDifferenceKg = this.state.initialWeight ? (this.state.dailyWeight - this.state.initialWeight) : 0;
                this.state.kcalSummary.intravenousTotal = this.state.kcalSummary.ivMedicine + this.state.kcalSummary.tpn + kcalFromKristalloider;

                // Beräkna timdiures
                if (duration > 0 && this.state.dailyWeight > 0) {
                    this.state.avgHourlyDiuresis = this.state.totalDiuresisMl / duration / this.state.dailyWeight;
                } else {
                    this.state.avgHourlyDiuresis = 0;
                }
            },
            updateSummaryUI() {
                for (const key in this.dom.summary) {
                    if (this.dom.summary[key]) {
                        const value = this.state[key];
                        if (key === 'avgHourlyDiuresis') {
                            this.dom.summary[key].textContent = value.toFixed(2);
                            this.dom.summary[key].classList.toggle('low-diuresis', value < 0.5 && this.state.totalDiuresisMl > 0);
                        } else {
                            this.dom.summary[key].textContent = typeof value === 'number' ? (key.includes('Kg') ? value.toFixed(1) : Math.round(value)) : value;
                        }
                    }
                }
            },
            calculateDiuresis() {
                const desiredBalance = parseFloat(document.getElementById('desiredBalanceTomorrow').value) || 0;
                const calcTime = document.getElementById('diuresisCalcTime').value;
                const remainingHours = this.calculateDurationInHours(calcTime, '06:00');
                const plannedSingleIntake = parseFloat(document.getElementById('plannedSingleIntake').value) || 0;
                const plannedHourlyIntake = parseFloat(document.getElementById('plannedHourlyIntake').value) || 0;
                const plannedSingleLosses = parseFloat(document.getElementById('plannedSingleLosses').value) || 0;
                
                document.getElementById('remainingTimeTo0600').value = remainingHours.toFixed(1);
                
                const expectedPerspiratio = this.calculatePerspiratio(remainingHours, this.state.dailyWeight);
                document.getElementById('expectedPerspiratioRemaining').value = expectedPerspiratio;
                
                const totalFutureIntake = plannedSingleIntake + (plannedHourlyIntake * remainingHours);
                const totalFutureLoss = plannedSingleLosses + expectedPerspiratio;
                
                const requiredDiuresis = this.state.netBalanceMl + totalFutureIntake - totalFutureLoss - desiredBalance;
                const diuresisPerHour = remainingHours > 0 ? requiredDiuresis / remainingHours : 0;

                // Update summary table in modal
                document.getElementById('summaryBalanceTillNow').textContent = Math.round(this.state.netBalanceMl);
                document.getElementById('summaryRemainingHoursFuture').textContent = remainingHours.toFixed(1);
                document.getElementById('summaryPlannedSingleIntakeSummary').textContent = Math.round(plannedSingleIntake);
                document.getElementById('plannedHourlyIntakeDisplay').textContent = Math.round(plannedHourlyIntake);
                document.getElementById('remainingHoursDisplay').textContent = remainingHours.toFixed(1);
                document.getElementById('summaryPlannedHourlyIntakeTotal').textContent = Math.round(plannedHourlyIntake * remainingHours);
                document.getElementById('summaryPlannedSingleLossesSummary').textContent = Math.round(plannedSingleLosses);
                document.getElementById('summaryExpectedPerspiratioRemainingSummary').textContent = Math.round(expectedPerspiratio);
                document.getElementById('summaryDesiredBalanceTomorrowSummary').textContent = Math.round(desiredBalance);
                document.getElementById('summaryTotalCalculatedIntake').textContent = Math.round(this.state.totalIntakeMl + totalFutureIntake);
                document.getElementById('summaryTotalCalculatedLossExclDiuresis').textContent = Math.round(this.state.totalOtherLossMl + this.state.totalPerspiratioMl + totalFutureLoss);
                document.getElementById('diuresisNeedPerHour').textContent = diuresisPerHour.toFixed(1);
            },
            openModal(targetId) {
                if (targetId === 'calculationsModalOverlay') this.populateKcalTableInModal();
                if (targetId === 'printDetailedSummaryModalOverlay') this.populatePrintModal();
                if (targetId === 'diuresisCalculatorModalOverlay') {
                    this.setNow('diuresisCalcTime');
                    this.calculateDiuresis();
                }
                document.getElementById(targetId)?.classList.add('active');
                this.dom.body.classList.add('modal-open');
            },
            closeModal(targetId) {
                document.getElementById(targetId)?.classList.remove('active');
                this.dom.body.classList.remove('modal-open');
            },
             populateKcalTableInModal() {
                const categoryMapping = [
                    { name: 'Kristalloider/Kolloider', key: 'fluid', containerSuffix: 'Kristalloider' },
                    { name: 'Läkemedelsvätskor', key: 'medicine', containerSuffix: 'Medicine' },
                    { name: 'TPN/Sondmat', key: 'tpnSondmat', containerSuffix: 'TpnSondmat' }
                ];

                categoryMapping.forEach(mapping => {
                    const container = document.getElementById(`kcal${mapping.containerSuffix}Container`);
                    if (!container) return;

                    container.innerHTML = `<h3>Kaloriinnehåll ${mapping.name}</h3>`;
                    const table = document.createElement('table');
                    table.innerHTML = '<thead><tr><th>Vätska/Produkt</th><th style="text-align:right;">Kcal/ml</th></tr></thead>';
                    const tbody = document.createElement('tbody');
                    
                    const dataSet = this.data[mapping.key];
                    const items = [];

                    // Add custom options first if they exist
                    if (dataSet.customOption) items.push({ name: dataSet.customOption, kcal: 0 });
                    if (dataSet.customOption2) items.push({ name: dataSet.customOption2, kcal: 0 });
                    // Add options if they exist
                    if (dataSet.options) {
                        dataSet.options.forEach(opt => {
                            if (typeof opt === 'object') {
                                items.push(opt);
                            } else {
                                items.push({ name: opt, kcal: 0 });
                            }
                        });
                    }
                    // Add categorized items
                    if (dataSet.categories) {
                        for (const cat in dataSet.categories) {
                            items.push(...dataSet.categories[cat]);
                        }
                    }
                    
                    // Sort items alphabetically for better readability
                    items.sort((a, b) => (a.name || a).localeCompare(b.name || b));

                    // Remove duplicates
                    const uniqueItems = items.filter((item, index, self) =>
                        index === self.findIndex((t) => (
                            (t.name || t) === (item.name || item)
                        ))
                    );

                    uniqueItems.forEach(item => {
                        const name = item.name || item;
                        const kcal = item.kcal ?? 0;
                        tbody.innerHTML += `<tr><td>${name}</td><td style="text-align:right;">${kcal}</td></tr>`;
                    });

                    table.appendChild(tbody);
                    container.appendChild(table);
                });
            },
            populatePrintModal() {
                this.updateAllCalculations(); // Ensure state is current
                document.getElementById('summaryDate').textContent = document.getElementById('dateInput').value;
                document.getElementById('summaryTimePeriod').textContent = `${document.getElementById('startTime').value} - ${document.getElementById('endTime').value}`;
                const bedSelect = document.getElementById('bedSelect');
                document.getElementById('summaryLocation').textContent = bedSelect.value === 'Annan plats' ? document.getElementById('otherLocationInput').value : bedSelect.value;
                
                document.getElementById('printInitialWeight').textContent = `${this.state.initialWeight.toFixed(1)} kg`;
                document.getElementById('printDailyWeight').textContent = `${this.state.dailyWeight.toFixed(1)} kg`;
                document.getElementById('printIdealWeight').textContent = `${document.getElementById('idealWeight').value} kg ${this.state.adjustedWeight ? '(Justerad)' : ''}`;
                document.getElementById('printWeightDifference').textContent = `${this.state.weightDifferenceKg.toFixed(1)} kg`;

                document.getElementById('printTotalIntakeMl').textContent = `${Math.round(this.state.totalIntakeMl)} ml`;
                document.getElementById('printTotalLossMl').textContent = `${Math.round(this.state.totalLossMl)} ml`;
                document.getElementById('printNetBalanceMl').textContent = `${Math.round(this.state.netBalanceMl)} ml`;
                document.getElementById('printCumulativeBalanceMl').textContent = `${Math.round(this.state.cumulativeBalanceMl)} ml`;

                document.getElementById('printMedicineSedativeMl').textContent = `${Math.round(this.state.medicineCategoryTotals.Sedering)} ml`;
                document.getElementById('printMedicineAntibioticsMl').textContent = `${Math.round(this.state.medicineCategoryTotals.Antibiotika)} ml`;
                document.getElementById('printMedicineVasoactiveMl').textContent = `${Math.round(this.state.medicineCategoryTotals.Vasoaktiva)} ml`;
                document.getElementById('printMedicineOtherMl').textContent = `${Math.round(this.state.medicineCategoryTotals.Övrigt)} ml`;

                document.getElementById('printKcalPeroral').textContent = `${Math.round(this.state.kcalSummary.peroralt)} Kcal`;
                document.getElementById('printKcalSondmat').textContent = `${Math.round(this.state.kcalSummary.sondmat)} Kcal`;
                document.getElementById('printKcalIntravenousTotal').textContent = `${Math.round(this.state.kcalSummary.intravenousTotal)} Kcal`;
                document.getElementById('printTotalKcalIntake').textContent = `${Math.round(this.state.totalIntakeKcal)} Kcal`;
            },
            collectFormData() {
                const data = { patientInfo: {}, fluidEntries: [], medicineEntries: [], bloodProductEntries: [], tpnSondmatEntries: [], lossEntries: [], perspiratioCalc: {}, diuresisCalc: {} };
                ['dateInput', 'startTime', 'endTime', 'bedSelect', 'otherLocationInput', 'initialWeight', 'dailyWeight', 'height', 'gender', 'age', 'cumulativeBalancePrev', 'naclSyringes', 'pressureSets'].forEach(id => data.patientInfo[id] = document.getElementById(id).value);
                
                document.querySelectorAll('#fluidEntriesContainer [data-id]').forEach(row => data.fluidEntries.push({ selectValue: row.querySelector('.select-main').value, mlValue: row.querySelector('.ml-input').value, kcalValue: row.querySelector('.kcal-output').value, customValue: row.querySelector('.custom-input').value }));
                document.querySelectorAll('#medicineEntriesContainer [data-id]').forEach(row => data.medicineEntries.push({ selectValue: row.querySelector('.select-main').value, mlValue: row.querySelector('.ml-input').value, kcalValue: row.querySelector('.kcal-output').value, customValue: row.querySelector('.custom-input').value }));
                document.querySelectorAll('#bloodProductEntriesContainer [data-id]').forEach(row => data.bloodProductEntries.push({ selectValue: row.querySelector('.select-main').value, mlValue: row.querySelector('.ml-input').value }));
                document.querySelectorAll('#tpnSondmatEntriesContainer [data-id]').forEach(row => data.tpnSondmatEntries.push({ selectValue: row.querySelector('.select-main').value, mlValue: row.querySelector('.ml-input').value, kcalValue: row.querySelector('.kcal-output').value, customValue: row.querySelector('.custom-input').value }));
                document.querySelectorAll('#lossEntriesContainer [data-id]').forEach(row => {
                    if(row.dataset.id !== 'perspiratio_static') data.lossEntries.push({ selectValue: row.querySelector('.select-main').value, mlValue: row.querySelector('.ml-input').value, customValue: row.querySelector('.custom-input').value })
                });
                data.lossEntries.push({ selectValue: 'Perspiratio', mlValue: document.getElementById('lossMlInput_perspiratio_static').value }); // Add static perspiratio
                
                data.perspiratioCalc = { breathingSupport: document.getElementById('breathingSupport').value, maxTemp: document.getElementById('maxTemp').value };
                data.diuresisCalc = { desiredBalanceTomorrow: document.getElementById('desiredBalanceTomorrow').value, diuresisCalcTime: document.getElementById('diuresisCalcTime').value, plannedSingleIntake: document.getElementById('plannedSingleIntake').value, plannedHourlyIntake: document.getElementById('plannedHourlyIntake').value, plannedSingleLosses: document.getElementById('plannedSingleLosses').value };
                return data;
            },
            saveDataToFile() {
                try {
                    const data = this.collectFormData();
                    const jsonData = JSON.stringify(data, null, 2);
                    const now = new Date();
                    const time = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
                    const bed = data.patientInfo.bedSelect === 'Annan plats' ? (data.patientInfo.otherLocationInput || 'OkändSäng') : (data.patientInfo.bedSelect || 'OkändSäng');
                    const date = data.patientInfo.dateInput || 'OkäntDatum';
                    const filename = `${bed}_${date}_${time}.json`;
                    
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Error saving data:", error);
                }
            },
            loadDataFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        this.populateFormWithData(loadedData);
                    } catch (err) {
                        console.error("Error parsing JSON file:", err);
                        alert("Kunde inte läsa filen. Kontrollera att det är en giltig JSON-fil.");
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            },
            populateFormWithData(data) {
                // Clear existing dynamic rows
                Object.values(this.dom.containers).forEach(container => {
                    container.querySelectorAll('[data-id]:not([data-id="perspiratio_static"])').forEach(row => row.remove());
                });
                Object.keys(this.counters).forEach(key => this.counters[key] = 0);

                // Populate patient info
                for(const id in data.patientInfo) {
                    const el = document.getElementById(id);
                    if(el) el.value = data.patientInfo[id];
                }
                
                // Create and populate rows
                data.fluidEntries?.forEach(d => this.addRow('fluid', d));
                data.medicineEntries?.forEach(d => this.addRow('medicine', d));
                data.bloodProductEntries?.forEach(d => this.addRow('bloodProduct', d));
                data.tpnSondmatEntries?.forEach(d => this.addRow('tpnSondmat', d));
                data.lossEntries?.forEach(d => {
                    if (d.selectValue === 'Perspiratio') {
                        document.getElementById('lossMlInput_perspiratio_static').value = d.mlValue;
                    } else {
                        this.addRow('loss', d);
                    }
                });

                // Populate calculator sections
                if (data.perspiratioCalc) {
                    for(const id in data.perspiratioCalc) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.perspiratioCalc[id];
                    }
                }
                if (data.diuresisCalc) {
                    for(const id in data.diuresisCalc) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.diuresisCalc[id];
                    }
                }

                this.checkInitialInputColors();
                this.updateAllCalculations();
            },
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
