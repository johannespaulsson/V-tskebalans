<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vätskebalans Test 2</title>
    <!-- Länkar till Font Awesome för ikoner -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Grundläggande stil för body */
        body {
            font-family: 'Inter', sans-serif;
            margin: 5px;
            background-color: #f4f4f4;
            color: #333;
            font-size: 0.9rem;
        }

        /* Ny stil för att förhindra scrolling på body när modal är öppen */
        body.modal-open {
            overflow: hidden;
        }

        /* Stil för huvudbehållaren som centrerar innehållet */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
        }

        /* Stil för rubriker */
        h2 {
            color: #1a73e8;
            border-bottom: 1px solid #1a73e8;
            padding-bottom: 4px;
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
            font-size: 1.5em;
        }

        /* Rutnätslayout för patientinformationsfälten (3 kolumner) */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
        }

        /* Ny stil för 2-kolumns rutnät (används för Balansräkning) */
        .grid-container.two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Stil för varje rutnätsartikel (enkel inmatningsgrupp) */
        .grid-item {
            margin-bottom: 8px;
            background-color: #fcfcfc;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e5e5e5;
        }

        /* Stil för de yttre kolumnerna inom 2-kolumns rutnät */
        .grid-column-item {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .grid-column-item h3 {
            color: #1a73e8;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1.1em;
        }


        /* Stil för etiketter (labels) */
        .grid-item label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
        }

        /* Stil för alla inmatningsfält och select-menyer */
        .grid-item input[type="date"],
        .grid-item input[type="time"],
        .grid-item input[type="number"],
        .grid-item input[type="text"],
        .grid-item select {
            width: calc(100% - 10px);
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9rem;
            transition-property: border-color, box-shadow;
            transition-duration: 0.3s, 0.3s;
            transition-timing-function: ease, ease;
        }

        .grid-item input:focus,
        .grid-item select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        /* Stil för inmatningsgrupper med knapp (t.ex. tid + "Nu"-knapp) */
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input[type="time"] {
            flex-grow: 1;
            margin-right: 6px;
        }
        .input-group button {
            padding: 6px 10px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
        .input-group button:hover {
            background-color: #0d47a1;
            transform: translateY(-1px);
        }
        .input-group button:active {
            transform: translateY(0);
        }

        /* Stil för "viktigt input"-markering (ljusrosa bakgrund) */
        .important-input {
            background-color: #fff5f5;
            border-color: #ffdddd;
        }
        /* Stil för "fyllt input"-markering (ljusgrön bakgrund) */
        .filled-input {
            background-color: #f5fff5;
            border-color: #ddffdd;
        }

        /* Stil för numeriska inmatningar med plus/minus-knappar */
        .number-input-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .number-input-buttons input[type="number"] {
            flex-grow: 1;
            text-align: center;
            -moz-appearance: textfield;
            border-radius: 4px;
        }
        /* Döljer spinnknappar i WebKit-baserade webbläsare (Chrome, Safari, Edge) */
        .number-input-buttons input[type="number"]::-webkit-outer-spin-button,
        .number-input-buttons input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .number-input-buttons button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
            flex-shrink: 0;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
        .number-input-buttons button:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }
        .number-input-buttons button:active {
            transform: translateY(0);
        }

        /* Stil för "Annan plats" inmatningsfält när det visas */
        #otherLocationInput {
            margin-top: 6px;
            width: calc(100% - 10px);
        }

        /* Stil för det automatiskt beräknade Kcal-fältet */
        .calculated-output {
            background-color: #ffffff;
            border-color: #ccc;
        }

        /* Stil för enskild vätskerad (Kristalloider/Kolloider & Läkemedelsvätskor) */
        .fluid-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }

        /* Ny stil för blodprodukt rad (utan Kcal) */
        .blood-product-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }
        /* Ny stil för TPN/Sondmat rad (med Kcal) */
        .tpn-sondmat-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }
        /* Ny stil för förlust rad (utan Kcal) */
        .loss-entry-row {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            align-items: center;
            padding: 2px 0;
        }


        .fluid-entry-row .grid-item,
        .blood-product-entry-row .grid-item,
        .tpn-sondmat-entry-row .grid-item,
        .loss-entry-row .grid-item {
            margin-bottom: 0;
            padding: 0;
            background-color: transparent;
            border: none;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fluid-entry-row input,
        .fluid-entry-row select,
        .blood-product-entry-row input,
        .blood-product-entry-row select,
        .tpn-sondmat-entry-row input,
        .tpn-sondmat-entry-row select,
        .loss-entry-row input,
        .loss-entry-row select {
            width: 100%;
            padding: 3px;
            font-size: 0.8rem;
        }

        /* Stil för den egna vätskan/läkemedlet */
        .fluid-entry-row .custom-fluid-input,
        .blood-product-entry-row .custom-fluid-input,
        .tpn-sondmat-entry-row .custom-fluid-input,
        .loss-entry-row .custom-fluid-input {
            width: 100%;
            padding: 3px;
            font-size: 0.8rem;
        }

        .remove-fluid-button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition-property: background-color;
            transition-duration: 0.3s;
            transition-timing-function: ease;
            height: fit-content;
            align-self: center;
            line-height: 1;
        }
        .remove-fluid-button:hover {
            background-color: #c82333;
        }
        /* Stil för knappen som inte ska kunna tas bort */
        .remove-fluid-button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .remove-fluid-button.disabled:hover {
            background-color: #cccccc;
            transform: none;
        }


        .add-button {
            display: block;
            width: fit-content;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition-property: background-color, transform;
            transition-duration: 0.3s, 0.2s;
            transition-timing-function: ease, ease;
        }
        .add-button:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }

        /* Stil för tabellrubrikerna */
        .fluid-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #444;
        }
        /* Ny stil för blodprodukter tabellrubriker (utan Kcal) */
        .blood-product-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #444;
        }
        /* Ny stil för TPN/Sondmat tabellrubriker (med Kcal) */
        .tpn-sondmat-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #444;
        }
        /* Ny stil för förlust tabellrubriker (utan Kcal) */
        .loss-table-header {
            display: grid;
            grid-template-columns: 2.2fr 1fr auto;
            gap: 6px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #444;
        }
        .fluid-table-header div,
        .blood-product-table-header div,
        .tpn-sondmat-table-header div,
        .loss-table-header div {
            text-align: left;
        }
        /* Justera för att papperskorgskolumnen ska vara tom i headern */
        .fluid-table-header div:last-child,
        .blood-product-table-header div:last-child,
        .tpn-sondmat-table-header div:last-child,
        .loss-table-header div:last-child {
            width: 25px;
        }

        /* Stil för notis om justerad idealvikt */
        .adjusted-weight-notice {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        /* Stil för temperaturinmatningsgrupper */
        .temp-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 5px;
        }
        .temp-input-group label {
            flex-basis: 60px;
            text-align: right;
            margin-right: 5px;
        }
        .temp-input-group input {
            width: 60px;
            text-align: center;
            padding: 4px;
        }

        /* NYA STYLING REGLER */
        /* Flexbox för att placera Beräknad Perspiratio-input och knapp på samma rad */
        .calculated-perspiratio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Justera bredd för input i den nya gruppen */
        .calculated-perspiratio-group input[type="text"] {
            flex-grow: 1;
            max-width: 150px;
            text-align: center;
        }

        /* Justera knappen i den nya gruppen */
        .calculated-perspiratio-group button {
            margin-top: 0 !important;
            flex-shrink: 0;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Tvåkolumns layout för temperaturtimmar */
        .temp-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 10px;
        }
        /* Ingen marginal längst ner för temp-input-group när den är i grid */
        .temp-grid-container .temp-input-group {
            margin-bottom: 0;
        }

        /* --- Modal Specifika Stilar --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Dimmed background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to appear on top */
            visibility: hidden; /* Hidden by default */
            opacity: 0;
            transition-property: visibility, opacity;
            transition-duration: 0.3s, 0.3s;
            transition-timing-function: ease, ease;
        }
        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            max-width: 950px; /* Increased max-width for 3 columns */
            width: 90%; /* Responsive width */
            position: relative;
            transform: translateY(-20px); /* Small animation effect */
            transition-property: transform;
            transition-duration: 0.3s;
            transition-timing-function: ease;
            /* För att modal-content ska anpassa sin höjd efter innehållet och ha egen scroll */
            max-height: 90vh; /* Sätter maxhöjden till 90% av viewportens höjd */
            overflow-y: auto; /* Lägger till scroll om innehållet överskrider maxhöjden */
            box-sizing: border-box; /* Inkluderar padding i höjden */
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        /* Adjusted grid for modal content to be 3 columns */
        .modal-content .grid-container.modal-three-column-grid { /* New class for specific modal grid */
            display: grid;
            /* Using minmax(0, 1fr) to ensure columns don't grow beyond 1fr due to content */
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 15px;
            /* Säkerställer att alla grid-items sträcker sig till samma höjd */
            align-items: stretch;
        }
        /* Added to explicitly make grid-column-items fill their grid cells */
        .modal-content .grid-container.modal-three-column-grid > .grid-column-item {
            width: 100%; /* Ensure it takes full width of its grid cell */
            height: 100%; /* Ensure it takes full height of its grid cell */
            box-sizing: border-box; /* Ensures padding/border are included in width/height */
        }
        .modal-content h3 {
            color: #1a73e8;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 1.1em;
        }
        /* Justerad font-storlek för modal-p och modal-ul */
        .modal-content p {
            font-size: 0.7rem; /* Något mindre */
            margin-bottom: 5px;
            line-height: 1.4;
            word-wrap: break-word; /* Lägg till för att tvinga radbrytning */
            overflow-wrap: break-word; /* Fallback för word-wrap */
        }
        .modal-content ul {
            list-style: none;
            padding-left: 0;
            font-size: 0.65rem; /* Något mindre */
        }
        .modal-content ul li {
            margin-bottom: 3px;
        }
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; /* Smaller text for tables to fit 3 columns */
        }
        .modal-content th, .modal-content td {
            border: 1px solid #eee;
            padding: 4px; /* Reduced padding for table cells */
            text-align: left;
        }
        .modal-content th {
            background-color: #e9e9e9;
            font-weight: 600;
        }
        .modal-content tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        .modal-content .category-heading {
            font-weight: bold;
            background-color: #e0e0e0;
            padding: 4px 6px;
            margin-top: 8px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 0.75rem; /* Smaller category heading */
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition-property: color;
            transition-duration: 0.2s;
            transition-timing-function: ease;
        }
        .modal-close-button:hover {
            color: #333;
        }
        /* Stil för den statiska Perspiratio-selecten för att säkerställa att den syns tydligt */
        #lossSelect_perspiratio_static {
            color: #333 !important; /* Force a darker color */
            font-weight: bold; /* Make it bold */
            opacity: 1; /* Ensure full opacity */
        }

        /* Specific styles for Diuresis Calculator modal */
        #diuresisCalculatorModalOverlay .modal-content {
            max-width: 800px; /* Slightly narrower for this calculator */
        }
        #diuresisCalculatorModalOverlay .grid-container {
            grid-template-columns: 1fr; /* Stack columns on smaller screens */
            gap: 15px; /* Consistent gap */
        }
        #diuresisCalculatorModalOverlay .grid-container.two-column-diuresis {
            grid-template-columns: 1fr 1fr; /* Two columns for sections */
            gap: 15px;
        }
        #diuresisCalculatorModalOverlay .grid-column-item {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        #diuresisCalculatorModalOverlay .diuresis-summary-table td,
        #diuresisCalculatorModalOverlay .diuresis-summary-table th {
            padding: 5px; /* Adjusted padding for summary table */
            font-size: 0.8rem;
        }
        #diuresisCalculatorModalOverlay .diuresis-summary-table .detail-row {
            font-size: 0.75rem;
            color: #555;
            padding-left: 15px;
        }
        #diuresisCalculatorModalOverlay .highlight-row {
            background-color: #e6ffe6; /* Light green for highlight */
            font-weight: bold;
        }

        /* Stilar för patientetikett-rutan i detaljerad sammanställning */
        .patient-label-box {
            width: 9.5cm;
            height: 4.5cm;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Vänsterjustera innehållet */
            text-align: left; /* Vänsterjustera texten */
            font-size: 0.9rem;
            margin: 15px 0 25px 0; /* Ingen auto-marginal för att möjliggöra vänsterjustering av rutan */
            box-sizing: border-box; /* Inkludera padding/border i storleken */
            padding-left: 10px; /* Lägg till lite padding på vänster sida */
        }

        /* Stilar för allmän information i detaljerad sammanställning */
        .summary-info {
            margin-bottom: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .summary-info p {
            margin: 0;
        }

        /* Stilar för tabellerna i detaljerad sammanställning modalen */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.8rem; /* Anpassa storlek för utskrift */
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
        }
        .summary-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .summary-table .numeric-value {
            text-align: right;
            font-weight: 500;
        }

        /* Mediafråga för mindre skärmar (staplar kolumnerna) */
        @media (max-width: 768px) {
            .grid-container, .grid-container.two-column-grid {
                grid-template-columns: 1fr;
            }
            .container {
                margin: 5px;
                padding: 10px;
            }
            body {
                font-size: 0.85rem;
            }
            .grid-column-item {
                padding: 10px;
            }
            .fluid-entry-row, .fluid-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .blood-product-entry-row, .blood-product-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .tpn-sondmat-entry-row, .tpn-sondmat-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .loss-entry-row, .loss-table-header {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            .fluid-entry-row input,
            .fluid-entry-row select,
            .blood-product-entry-row input,
            .blood-product-entry-row select,
            .tpn-sondmat-entry-row input,
            .tpn-sondmat-entry-row select,
            .loss-entry-row input,
            .loss-entry-row select {
                width: calc(100% - 6px);
            }
            .fluid-table-header div,
            .blood-product-table-header div,
            .tpn-sondmat-table-header div,
            .loss-table-header div {
                text-align: center;
            }
            /* Återställ temp-grid-container till en kolumn på små skärmar */
            .temp-grid-container {
                grid-template-columns: 1fr;
            }
            /* Justera perspiratio-gruppen på små skärmar */
            .calculated-perspiratio-group {
                flex-direction: column;
                align-items: stretch;
            }
            .calculated-perspiratio-group input[type="text"] {
                max-width: 100%;
            }
            /* Modal justeringar för små skärmar */
            .modal-content .grid-container.modal-three-column-grid,
            #diuresisCalculatorModalOverlay .grid-container.two-column-diuresis { /* Applies to modal's inner grids */
                grid-template-columns: 1fr; /* Single column on smaller screens */
            }
            .modal-content p {
                font-size: 0.8rem;
            }
            .modal-content ul {
                font-size: 0.75rem;
            }
            .modal-content table {
                font-size: 0.7rem;
            }

            /* Justera patientetikettboxen på små skärmar för att behålla dimensionerna */
            .patient-label-box {
                width: 9.5cm; /* Behåll specifik bredd */
                height: 4.5cm; /* Behåll specifik höjd */
                margin: 15px auto 25px auto; /* Centrera på små skärmar igen */
                justify-content: center; /* Centrera innehåll på små skärmar */
                text-align: center; /* Centrera text på små skärmar */
                padding-left: 0; /* Ta bort extra padding på små skärmar */
            }
        }

        /* --- Print-specifika stilar --- */
        @media print {
            body > *:not(#printDetailedSummaryModalOverlay) {
                display: none; /* Hide everything except the print modal overlay */
            }

            #printDetailedSummaryModalOverlay {
                position: static; /* Remove fixed positioning for print */
                top: auto;
                left: auto;
                width: 100%;
                height: auto;
                background-color: transparent; /* No dimmed background on print */
                display: block; /* Ensure it's visible */
                visibility: visible;
                opacity: 1;
                box-shadow: none; /* No shadow on print */
            }

            #printDetailedSummaryModalOverlay .modal-content {
                max-width: 100%; /* Use full width for print */
                width: 100%;
                box-shadow: none;
                border-radius: 0;
                padding: 0; /* No padding on content for full use of paper */
                transform: none; /* Remove translation */
                max-height: none; /* No max height for print */
                overflow-y: visible; /* Allow content to flow */
                background-color: transparent; /* No background on print */
            }

            .modal-close-button, .add-button {
                display: none; /* Hide close button and print button itself */
            }

            .patient-label-box {
                border: 1px solid #000; /* Ensure border is visible on print */
            }

            .summary-table {
                border: 1px solid #000; /* Ensure table borders are visible */
            }
            .summary-table th, .summary-table td {
                border: 1px solid #000; /* Ensure cell borders are visible */
                padding: 4px; /* Adjust padding for print if needed */
            }

            /* Adjust font sizes for better print readability */
            .modal-content h2 {
                font-size: 1.2em;
            }
            .modal-content h3 {
                font-size: 1em;
            }
            .summary-info p,
            .summary-table,
            .summary-table th,
            .summary-table td {
                font-size: 0.75em; /* Slightly larger for print */
            }

            /* Page breaks for tables if necessary */
            .summary-table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Patientinformation</h2>
        <div class="grid-container">
            <!-- Datumfält -->
            <div class="grid-item">
                <label for="dateInput">Datum:</label>
                <input type="date" id="dateInput">
            </div>
            <!-- Starttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="startTime">Beräknat från (starttid):</label>
                <div class="input-group">
                    <input type="time" id="startTime" value="06:00">
                    <button onclick="setNow('startTime')">Nu</button>
                </div>
            </div>
            <!-- Sluttid med "Nu"-knapp -->
            <div class="grid-item">
                <label for="endTime">till (sluttid):</label>
                <div class="input-group">
                    <input type="time" id="endTime" value="06:00">
                    <button onclick="setNow('endTime')">Nu</button>
                </div>
            </div>
            <!-- Sängval och "Annan plats" fält -->
            <div class="grid-item">
                <label for="bedSelect">Säng:</label>
                <select id="bedSelect">
                    <option value="">Välj säng</option>
                    <option value="IVA 1">IVA 1</option>
                    <option value="IVA 2">IVA 2</option>
                    <option value="IVA 3">IVA 3</option>
                    <option value="IVA 4">IVA 4</option>
                    <option value="IVA 5">IVA 5</option>
                    <option value="IVA 6">IVA 6</option>
                    <option value="IVA 7">IVA 7</option>
                    <option value="IVA 8">IVA 8</option>
                    <option value="IVA 9">IVA 9</option>
                    <option value="IVA 10">IVA 10</option>
                    <option value="IVA 11">IVA 11</option>
                    <option value="IVA 12">IVA 12</option>
                    <option value="IMA 1">IMA 1</option>
                    <option value="IMA 2">IMA 2</option>
                    <option value="IMA 3">IMA 3</option>
                    <option value="IMA 4">IMA 4</option>
                    <option value="Annan plats">Annan plats</option>
                </select>
                <input type="text" id="otherLocationInput" placeholder="Ange annan plats" style="display: none;">
            </div>
            <!-- Utgångsvikt/torrvikt -->
            <div class="grid-item">
                <label for="initialWeight">Utgångsvikt/torrvikt (kg):</label>
                <input type="number" id="initialWeight" step="0.1" class="important-input" placeholder="t.ex. 70.0">
            </div>
            <!-- Dagens vikt -->
            <div class="grid-item">
                <label for="dailyWeight">Dagens vikt (kg):</label>
                <input type="number" id="dailyWeight" step="0.1" class="important-input" placeholder="t.ex. 71.5" value="0">
            </div>
            <!-- Längd -->
            <div class="grid-item">
                <label for="height">Längd (cm):</label>
                <input type="number" id="height" step="0.1" class="important-input" placeholder="t.ex. 175.0">
            </div>
            <!-- Kön -->
            <div class="grid-item">
                <label for="gender">Kön:</label>
                <select id="gender" class="important-input">
                    <option value="">Välj kön</option>
                    <option value="Man">Man</option>
                    <option value="Kvinna">Kvinna</option>
                </select>
            </div>
            <!-- Ny ruta för Idealvikt -->
            <div class="grid-item">
                <label for="idealWeight">Idealvikt (kg):</label>
                <input type="text" id="idealWeight" readonly class="calculated-output" value="Var god ange längd och kön">
                <span id="adjustedWeightNotice" class="adjusted-weight-notice" style="display: none;">(Justerad vikt)</span>
            </div>
            <!-- Kumulativ balans föregående dygn -->
            <div class="grid-item">
                <label for="cumulativeBalancePrev">Kumulativ balans föregående dygn (ml):</label>
                <input type="number" id="cumulativeBalancePrev" value="0" step="1">
            </div>
            <!-- Antal förfyllda 10ml NaCl-sprutor med +/- knappar -->
            <div class="grid-item">
                <label for="naclSyringes">Antal förfyllda 10ml NaCl-sprutor:</label>
                <div class="number-input-buttons">
                    <button onclick="changeNumber('naclSyringes', -1)"><i class="fas fa-minus"></i></button>
                    <input type="number" id="naclSyringes" value="0" step="1">
                    <button onclick="changeNumber('naclSyringes', 1)"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <!-- Antal tryckset med +/- knappar -->
            <div class="grid-item">
                <label for="pressureSets">Antal tryckset (CVP-set = 2):</label>
                <div class="number-input-buttons">
                    <button onclick="changeNumber('pressureSets', -1)"><i class="fas fa-minus"></i></button>
                    <input type="number" id="pressureSets" value="0" step="1">
                    <button onclick="changeNumber('pressureSets', 1)"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ny sektion för Balansräkning -->
    <div class="container" style="margin-top: 8px;">
        <h2>Balansräkning</h2>
        <div class="grid-container two-column-grid">
            <!-- Första kolumn: Kristalloider/Kolloider -->
            <div class="grid-column-item">
                <h3>Kristalloider/Kolloider</h3>
                <!-- Tabellrubriker för vätskeraderna -->
                <div class="fluid-table-header">
                    <div>Vätska</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="fluidEntriesContainer">
                    <!-- Initial vätskerad -->
                    <div class="fluid-entry-row" data-row-id="1">
                        <div class="grid-item">
                            <select id="fluidSelect_1"></select>
                            <!-- Textruta för övrig vätska flyttad in i samma grid-item -->
                            <input type="text" id="customFluidInput_1" class="custom-fluid-input" placeholder="Ange övrig vätska" style="display: none;">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="mlInput_1" step="1" value="0">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="kcalOutput_1" step="1" value="0" class="calculated-output">
                        </div>
                        <button class="remove-fluid-button" data-row-id="1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <button id="addFluidButton" class="add-button">Lägg till vätska</button>
            </div>

            <!-- Andra kolumn: Läkemedelsvätskor -->
            <div class="grid-column-item">
                <h3>Läkemedelsvätskor</h3>
                <!-- Tabellrubriker för läkemedelsvätskeraderna -->
                <div class="fluid-table-header">
                    <div>Läkemedel</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="medicineEntriesContainer">
                    <!-- Läkemedelsvätskerader läggs till här dynamiskt -->
                    <div class="fluid-entry-row" data-row-id="med_1">
                        <div class="grid-item">
                            <select id="medicineSelect_med_1"></select>
                            <input type="text" id="customMedicineInput_med_1" class="custom-fluid-input" placeholder="Ange övrigt läkemedel" style="display: none;">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="medicineMlInput_med_1" step="1" value="0">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="medicineKcalOutput_med_1" step="1" value="0" class="calculated-output">
                        </div>
                        <button class="remove-fluid-button" data-row-id="med_1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <button id="addMedicineButton" class="add-button">Lägg till läkemedelsvätska</button>
            </div>

            <!-- Ny kolumn: Blodprodukter -->
            <div class="grid-column-item">
                <h3>Blodprodukter</h3>
                <div class="blood-product-table-header"> <!-- Specifik header för blodprodukter -->
                    <div>Blodprodukt</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="bloodProductEntriesContainer">
                    <!-- Initial blodprodukt rad -->
                    <div class="blood-product-entry-row" data-row-id="blood_1">
                        <div class="grid-item">
                            <select id="bloodProductSelect_blood_1"></select>
                        </div>
                        <div class="grid-item">
                            <input type="number" id="bloodProductMlInput_blood_1" step="1" value="0">
                        </div>
                        <button class="remove-fluid-button" data-row-id="blood_1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <button id="addBloodProductButton" class="add-button">Lägg till blodprodukt</button>
            </div>

            <!-- Ny kolumn: TPN/Sondmat/Peroralt -->
            <div class="grid-column-item">
                <h3>TPN/Sondmat/Peroralt</h3>
                <div class="tpn-sondmat-table-header"> <!-- Specifik header för TPN/Sondmat -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div>Kcal</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="tpnSondmatEntriesContainer">
                    <!-- Initial TPN/Sondmat rad -->
                    <div class="tpn-sondmat-entry-row" data-row-id="tpn_1">
                        <div class="grid-item">
                            <select id="tpnSondmatSelect_tpn_1"></select>
                            <input type="text" id="customTpnSondmatInput_tpn_1" class="custom-fluid-input" placeholder="Ange övrig sondmat" style="display: none;">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="tpnSondmatMlInput_tpn_1" step="1" value="0">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="tpnSondmatKcalOutput_tpn_1" step="1" value="0" class="calculated-output">
                        </div>
                        <button class="remove-fluid-button" data-row-id="tpn_1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <button id="addTpnSondmatButton" class="add-button">Lägg till TPN/Sondmat/Peroralt</button>
            </div>

            <!-- Ny kolumn: Förluster -->
            <div class="grid-column-item">
                <h3>Förluster</h3>
                <div class="loss-table-header"> <!-- Specifik header för Förluster -->
                    <div>Typ</div>
                    <div>Mängd (ml)</div>
                    <div></div> <!-- Tom div för att matcha ta bort-knappens kolumn -->
                </div>
                <div id="lossEntriesContainer">
                    <!-- Statisk, icke-borttagningsbar Perspiratio-rad -->
                    <div class="loss-entry-row" data-row-id="perspiratio_static">
                        <div class="grid-item">
                            <!-- Hardcode the option for "Perspiratio" as it's static and disabled -->
                            <select id="lossSelect_perspiratio_static" disabled>
                                <option value="Perspiratio" selected disabled>Perspiratio</option>
                            </select>
                            <!-- Ingen custom input behövs för Perspiratio -->
                        </div>
                        <div class="grid-item">
                            <input type="number" id="lossMlInput_perspiratio_static" step="1" value="0" readonly class="calculated-output">
                        </div>
                        <!-- Ingen ta bort-knapp för denna rad -->
                        <button class="remove-fluid-button disabled" disabled><i class="fas fa-trash"></i></button>
                    </div>

                    <!-- Här läggs övriga, dynamiska förlustrader till -->
                    <div class="loss-entry-row" data-row-id="loss_1">
                        <div class="grid-item">
                            <select id="lossSelect_loss_1"></select>
                            <input type="text" id="customLossInput_loss_1" class="custom-fluid-input" placeholder="Ange annan förlust" style="display: none;">
                        </div>
                        <div class="grid-item">
                            <input type="number" id="lossMlInput_loss_1" step="1" value="0">
                        </div>
                        <button class="remove-fluid-button" data-row-id="loss_1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <button id="addLossButton" class="add-button">Lägg till förlust</button>
            </div>

            <!-- Ny kolumn: Perspiratio-beräkning -->
            <div class="grid-column-item">
                <h3>Perspiratio-beräkning</h3>
                <div class="grid-item">
                    <label for="breathingSupport">Andningsstöd:</label>
                    <select id="breathingSupport">
                        <option value="none">Inget andningsstöd</option>
                        <option value="niv_hmef">NIV med HMEF</option>
                        <option value="niv_humid">NIV med aktiv befuktning</option>
                        <option value="hfnc">HFNC</option>
                        <option value="intub_hmef">Intuberad med HMEF</option>
                        <option value="intub_humid">Intuberad med aktiv befuktning</option>
                    </select>
                </div>
                <div class="grid-item">
                    <label>Temperatur över norm (timmar):</label>
                    <div class="temp-grid-container"> <!-- Ny container för två kolumner -->
                        <div class="temp-input-group">
                            <label for="temp37Hours">>37°C:</label>
                            <input type="number" id="temp37Hours" value="0" min="0" step="1"> timmar
                        </div>
                        <div class="temp-input-group">
                            <label for="temp38Hours">>38°C:</label>
                            <input type="number" id="temp38Hours" value="0" min="0" step="1"> timmar
                        </div>
                        <div class="temp-input-group">
                            <label for="temp39Hours">>39°C:</label>
                            <input type="number" id="temp39Hours" value="0" min="0" step="1"> timmar
                        </div>
                        <div class="temp-input-group">
                            <label for="temp40Hours">>40°C:</label>
                            <input type="number" id="temp40Hours" value="0" min="0" step="1"> timmar
                        </div>
                    </div>
                </div>
                <div class="grid-item">
                    <label id="calculatedPerspiratioLabel" for="calculatedPerspiratio">Beräknad Perspiratio (ml):</label>
                    <div class="calculated-perspiratio-group"> <!-- Ny flex-container för input och knapp -->
                        <input type="text" id="calculatedPerspiratio" readonly class="calculated-output" value="0">
                        <button id="transferPerspiratioButton" class="add-button" onclick="transferPerspiratioToLoss()">För över till förlust</button>
                    </div>
                </div>
            </div>

            <!-- NY KOLUMN: Verktyg -->
            <div class="grid-column-item">
                <h3>Verktyg</h3>
                <!-- Alla knappar får samma gröna färg genom add-button klassen -->
                <button id="openDiuresisCalculatorButton" class="add-button" style="margin-top: 0;">Diureskalkylator</button>
                <button id="openCalculationsButton" class="add-button">Beräkningar & Referensvärden</button>
                <button id="openPrintSummaryButton" class="add-button">Skriv ut detaljerad sammanställning</button>
            </div>

            <!-- NY KOLUMN: Sammanställning -->
            <div class="grid-column-item">
                <h3>Sammanställning</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding: 4px; border-bottom: 1px solid #ddd;">Post</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Volym (ml)</th>
                            <th style="text-align:right; padding: 4px; border-bottom: 1px solid #ddd;">Kcal</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td style="padding: 4px;">Totalt intag</td>
                            <td id="totalIntakeMl" style="text-align:right; padding: 4px;">0</td>
                            <td id="totalIntakeKcal" style="text-align:right; padding: 4px;">0</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Totalt förlust</td>
                            <td id="totalLossMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px; font-weight: bold;">Netto balans</td>
                            <td id="netBalanceMl" style="text-align:right; padding: 4px; font-weight: bold;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px;">Kumulativ balans</td>
                            <td id="cumulativeBalanceMl" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                        <!-- NY RAD FÖR VIKTDIFFERENS -->
                        <tr>
                            <td style="padding: 4px;">Differens mot utgångsvikt (kg)</td>
                            <td id="weightDifferenceKg" style="text-align:right; padding: 4px;">0</td>
                            <td style="text-align:right; padding: 4px;">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal för Beräkningar & Referensvärden -->
    <div id="calculationsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCalculationsModal()">×</button>
            <h2>Beräkningar & Referensvärden</h2>
            <p style="font-size: 0.85rem; margin-bottom: 10px;">Kalorier beräknas genom att multiplicera den angivna <strong>mängden (ml)</strong> med ett specifikt <strong>kcal/ml-värde</strong> för respektive vätska/produkt. Värden för "Övrig vätska", "Övrigt läkemedel" och "Sondmat övrig" är 0 kcal/ml som standard om inget annat anges.</p>
            <!-- New class for modal's inner grid to handle 3 columns -->
            <div class="grid-container modal-three-column-grid">
                <div class="grid-column-item">
                    <h3>Perspiratioberäkning</h3>
                    <p>Perspiratio beräknas baserat på patientens <strong>aktuella vikt</strong>, det <strong>valda tidsintervallet</strong> och typ av <strong>andningsstöd</strong>. En extra mängd läggs till för varje timme patienten har feber över 37°C.</p>
                    <h4>Basvärden (ml/kg/timme):</h4>
                    <ul>
                        <li>Inget andningsstöd: 0.5</li>
                        <li>NIV med HMEF: 0.55</li>
                        <li>NIV med aktiv befuktning: 0.4</li>
                        <li>HFNC: 0.3</li>
                        <li>Intuberad med HMEF: 0.75</li>
                        <li>Intuberad med aktiv befuktning: 0.2</li>
                    </ul>
                    <p><strong>Feberjustering:</strong> Ytterligare 0.1 ml/kg/timme per grad över 37°C.</p>
                </div>
                <div class="grid-column-item">
                    <h3>Idealvikt & Justerad Idealvikt</h3>
                    <p><strong>Idealvikt (Devine-formeln):</strong></p>
                    <ul>
                        <li><strong>Män:</strong> 50 + 0.91 x (Längd i cm - 152.4)</li>
                        <li><strong>Kvinnor:</strong> 45.5 + 0.91 x (Längd i cm - 152.4)</li>
                    </ul>
                    <p><strong>Justerad Idealvikt:</strong> Används om patientens dagliga vikt överstiger den beräknade idealvikten med mer än 20%.</p>
                    <ul>
                        <li>Justerad vikt = Idealvikt + 0.4 * (Aktuell vikt - Idealvikt)</li>
                    </ul>
                    <p><em>Alla vikter avrundas till en decimal.</em></p>
                </div>
                <!-- Nya Kcal-sektioner -->
                <div class="grid-column-item" id="kcalKristalloiderContainer"></div>
                <div class="grid-column-item" id="kcalMedicineContainer"></div>
                <div class="grid-column-item" id="kcalTpnSondmatContainer"></div>
            </div>
        </div>
    </div>

    <!-- START Diureskalkylator Modal -->
    <div id="diuresisCalculatorModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeDiuresisCalculator()">×</button>
            <h2>Diureskalkylator</h2>

            <!-- Instruktionsavsnitt -->
            <div class="grid-column-item" style="margin-bottom: 15px;">
                <h3>Instruktioner</h3>
                <p style="font-size: 0.8rem;">
                    Fyll i relevanta vätsketillförslar och vätskeförluster i <strong>huvudfliken</strong>.<br>
                    Fyll i önskad vätskebalans fram till kl 06:00 nästa dygn i detta avsnitt.<br>
                    Fyll i planerade framtida tillförslar/förluster i detta avsnitt.
                </p>
            </div>

            <div class="grid-container two-column-diuresis">
                <!-- Vänster kolumn: Grundläggande inställningar & mål + Aktuell balans (nuvarande tidpunkt) -->
                <div class="grid-column-item">
                    <h3>Grundläggande inställningar & mål</h3>
                    <div class="grid-item">
                        <label for="desiredBalanceTomorrow">Önskad vätskebalans (ml) fram till klockan 06:00 nästa dygn:</label>
                        <input type="number" id="desiredBalanceTomorrow" step="1" value="0">
                    </div>
                    <div class="grid-item">
                        <label for="diuresisCalcTime">Beräkning från klockslag:</label>
                        <div class="input-group">
                            <input type="time" id="diuresisCalcTime">
                            <button onclick="setNow('diuresisCalcTime')">Nu</button>
                        </div>
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Tidpunkt du gör din beräkning.</p>
                    </div>
                </div>

                <!-- Höger kolumn: Planerad framtida balans -->
                <div class="grid-column-item">
                    <h3>Planerad framtida balans (från 'Beräkning från' till 06:00 nästa dygn)</h3>
                    <div class="grid-item">
                        <label for="remainingTimeTo0600">Tid kvar till 06:00 (timmar):</label>
                        <input type="text" id="remainingTimeTo0600" readonly class="calculated-output">
                    </div>
                    <div class="grid-item">
                        <label for="expectedPerspiratioRemaining">Förväntad Perspiratio (återstående till 06:00) (ml):</label>
                        <input type="text" id="expectedPerspiratioRemaining" readonly class="calculated-output">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Baseras på vikt och den aktuella feberjusteringsgraden från huvudfliken.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleIntake">Förväntad vätsketillförsel (engångsdoser) (ml):</label>
                        <input type="number" id="plannedSingleIntake" step="1" value="0">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade enstaka infusioner/vätskor.</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedHourlyIntake">Förväntad vätsketillförsel per timma (ml/h):</label>
                        <input type="number" id="plannedHourlyIntake" step="1" value="0">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Kontinuerliga dropp (ex. Propofol, Noradrenalin).</p>
                    </div>
                    <div class="grid-item">
                        <label for="plannedSingleLosses">Förväntade övriga förluster (engångsförluster) (ml):</label>
                        <input type="number" id="plannedSingleLosses" step="1" value="0">
                        <p style="font-size: 0.75rem; margin-top: 4px; color: #666;">Planerade/förväntade enstaka förluster.</p>
                    </div>
                </div>
            </div>

            <!-- Resultat och Diuresbehov -->
            <div class="grid-column-item" style="margin-top: 15px;">
                <h3>Resultat och Diuresbehov</h3>
                <table class="diuresis-summary-table" style="width:100%; border-collapse: collapse;">
                    <tbody>
                        <tr>
                            <td colspan="2" class="category-heading">Aktuella Värden (från Huvudflik)</td>
                        </tr>
                        <tr>
                            <td>Aktuell vätskebalans (ml)</td>
                            <td id="summaryBalanceTillNow" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Aktuell tillförsel (ml)</td>
                            <td id="summaryActualIntakeMain" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Aktuella förluster (exkl. Diures) (ml)</td>
                            <td id="summaryActualLossExclDiuresisMain" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Aktuell diures (ml)</td>
                            <td id="summaryActualDiuresisMain" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Aktuell perspiratio (ml)</td>
                            <td id="summaryActualPerspiratioMain" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Planerade Framtida Värden (från nu till 06:00 nästa dygn)</td>
                        </tr>
                        <tr>
                            <td>Tid kvar till 06:00 (timmar)</td>
                            <td id="summaryRemainingHoursFuture" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad engångstillförsel (ml)</td>
                            <td id="summaryPlannedSingleIntakeSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad kontinuerlig tillförsel (ml/h)</td>
                            <td id="summaryPlannedHourlyIntakeSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntade engångsförluster (ml)</td>
                            <td id="summaryPlannedSingleLossesSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Förväntad perspiratio (ml)</td>
                            <td id="summaryExpectedPerspiratioRemainingSummary" style="text-align:right;">0</td>
                        </tr>

                        <tr>
                            <td colspan="2" class="category-heading" style="margin-top: 15px;">Sammanställda Beräkningar & Diuresbehov</td>
                        </tr>
                        <tr>
                            <td>Önskad vätskebalans vid 06:00 nästa dygn (ml)</td>
                            <td id="summaryDesiredBalanceTomorrowSummary" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknad total tillförsel (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedIntake" style="text-align:right;">0</td>
                        </tr>
                        <tr>
                            <td>Beräknade totala förluster (exkl. Diures) (till 06:00 nästa dygn) (ml)</td>
                            <td id="summaryTotalCalculatedLossExclDiuresis" style="text-align:right;">0</td>
                        </tr>
                        <tr class="highlight-row">
                            <td>Diuresbehov per timma (för återstående tid) (ml/h)</td>
                            <td id="diuresisNeedPerHour" style="text-align:right;">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button onclick="closeDiuresisCalculator()" class="add-button" style="margin-top: 15px;">Tillbaka till Vätskebalans</button>
        </div>
    </div>
    <!-- END Diureskalkylator Modal -->

    <!-- START Detaljerad Sammanställning Modal -->
    <div id="printDetailedSummaryModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closePrintSummaryModal()">×</button>
            <h2>Vätskebalansräkning</h2>

            <!-- Ruta för patientetikett -->
            <div class="patient-label-box">
                Plats för patientetikett
            </div>

            <!-- Allmän information om patient och tidsperiod -->
            <div class="summary-info">
                <p><strong>Datum:</strong> <span id="summaryDate"></span></p>
                <p><strong>Tidsperiod:</strong> <span id="summaryTimePeriod"></span></p>
                <p><strong>Plats:</strong> <span id="summaryLocation"></span></p>
            </div>

            <!-- Vikter -->
            <h3>Vikter</h3>
            <table class="summary-table">
                <tr>
                    <td>Utgångsvikt/torrvikt:</td>
                    <td id="printInitialWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Dagens vikt:</td>
                    <td id="printDailyWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Idealvikt (beräknad/justerad):</td>
                    <td id="printIdealWeight" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Differens mot utgångsvikt:</td>
                    <td id="printWeightDifference" class="numeric-value"></td>
                </tr>
            </table>

            <!-- Vätskebalansberäkningar -->
            <h3>Vätskebalans</h3>
            <table class="summary-table">
                <tr>
                    <td>Totalt intag:</td>
                    <td id="printTotalIntakeMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Totalt förlust:</td>
                    <td id="printTotalLossMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Netto balans:</td>
                    <td id="printNetBalanceMl" class="numeric-value"></td>
                </tr>
                <tr>
                    <td>Kumulativ balans:</td>
                    <td id="printCumulativeBalanceMl" class="numeric-value"></td>
                </tr>
            </table>

            <!-- Läkemedelsvolymer (subkategoriserade) -->
            <h3>Läkemedelsvolymer (totalt)</h3>
            <table class="summary-table">
                <tr>
                    <td>Sedativa:</td>
                    <td id="printMedicineSedativeMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Antibiotika:</td>
                    <td id="printMedicineAntibioticsMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Vasoaktiva:</td>
                    <td id="printMedicineVasoactiveMl" class="numeric-value">0 ml</td>
                </tr>
                <tr>
                    <td>Övriga läkemedel:</td>
                    <td id="printMedicineOtherMl" class="numeric-value">0 ml</td>
                </tr>
            </table>

            <!-- Kcal-intag (uppdelat) -->
            <h3>Kcal-intag</h3>
            <table class="summary-table">
                <tr>
                    <td>Kcal från peroralt intag:</td>
                    <td id="printKcalPeroral" class="numeric-value">0 Kcal</td>
                </tr>
                <tr>
                    <td>Kcal från sondmat:</td>
                    <td id="printKcalSondmat" class="numeric-value">0 Kcal</td>
                </tr>
                <!-- Förenad rad för IV Läkemedel och TPN -->
                <tr>
                    <td>Kcal från intravenös tillförsel:</td>
                    <td id="printKcalIntravenousTotal" class="numeric-value">0 Kcal</td>
                </tr>
                <tr>
                    <td><strong>Totalt Kcal intag:</strong></td>
                    <td id="printTotalKcalIntake" class="numeric-value">0 Kcal</td>
                </tr>
            </table>

            <!-- Utskriftsknapp -->
            <button class="add-button" style="margin-top: 20px;" onclick="printSummaryContent()">Skriv ut</button>
        </div>
    </div>
    <!-- END Detaljerad Sammanställning Modal -->

    <script>
        // Globala räknare för att säkerställa att de är definierade när de anropas från HTML
        let fluidEntryCounter = 1;
        let medicineEntryCounter = 1;
        let bloodProductCounter = 1;
        let tpnSondmatEntryCounter = 1;
        let lossEntryCounter = 1;

        // Globalt objekt för att hålla appens tillstånd och underlätta datadelning
        let appState = {
            totalIntakeMl: 0,
            totalIntakeKcal: 0,
            totalLossMl: 0,
            netBalanceMl: 0,
            cumulativeBalanceMl: 0,
            weightDifferenceKg: 0,
            totalDiuresisMl: 0,
            totalPerspiratioMl: 0, // This is the total perspiratio for the main app's period
            totalOtherLossMl: 0, // Losses excluding Diuresis and Perspiratio
            dailyWeight: 0,
            height: 0,
            gender: '',
            breathingSupport: 'none',
            temp37Hours: 0,
            temp38Hours: 0,
            temp39Hours: 0,
            temp40Hours: 0,
            mainAppStartTime: '06:00',
            mainAppEndTime: '06:00',

            // Nya fält för detaljerad utskrift
            patientDate: '',
            patientTimePeriod: '',
            patientLocation: '',
            initialWeight: 0,
            idealWeight: 0,
            adjustedWeight: false,

            medicineCategoryTotals: {
                Sedering: 0,
                Antibiotika: 0,
                Vasoaktiva: 0,
                Övrigt: 0
            },
            kcalSummary: {
                peroralt: 0,
                sondmat: 0,
                tpn: 0,
                ivMedicine: 0,
                // New combined total
                intravenousTotal: 0 // Renamed to clearly indicate combined intravenous total
            }
        };


        // Data för kcal-tabellen i modalen och för att populera select-menyerna
        let kcalData = {
            "Kristalloider/Kolloider": [
                { name: "Övrig vätska", kcal: "0" },
                { name: "Glukos 25 mg/ml", kcal: "0.1" },
                { name: "Glukos 50 mg/ml", kcal: "0.2" },
                { name: "Glukos 100 mg/ml", kcal: "0.4" },
                { name: "Glukos 200 mg/ml", kcal: "0.8" },
                { name: "Glukos 300 mg/ml", kcal: "1.2" },
                { name: "Albumin 20%", kcal: "0.8" },
                { name: "Albumin 5%", kcal: "0" },
                { name: "Glukos 100 mg/ml med el", kcal: "0.4" },
                { name: "Glukos 50 mg/ml med El", kcal: "0.2" },
                { name: "NaCl Picco-Kalibrering", kcal: "0" },
                { name: "Natriumbikarbonat 50 mg/ml", kcal: "0" },
                { name: "Natriumklorid 9 mg/ml", kcal: "0" },
                { name: "Natriumklorid hyperton", kcal: "0" },
                { name: "Plasmolyte", kcal: "0" },
                { name: "Ringer-Acetat", kcal: "0" }
            ],
            "Läkemedelsvätskor": [
                { name: "Övrigt läkemedel", kcal: "0", defaultMl: 0 },
                { name: "Pip/Taz 4g x 3", kcal: "0", defaultMl: 60 },
                { name: "Övrig Antibiotika", kcal: "0", defaultMl: 0 },
                // NYTT LÄKEMEDEL: Kaspofungin
                { name: "Kaspofungin", kcal: "0", defaultMl: 250 },
                { name: "Dexdor", kcal: "0", defaultMl: 0 },
                { name: "Esketamin", kcal: "0", defaultMl: 0 },
                { name: "Klonidin", kcal: "0", defaultMl: 0 },
                { name: "Midazolam", kcal: "0", defaultMl: 0 },
                { name: "Propofol 10mg/ml", kcal: "1.1", defaultMl: 0 },
                { name: "Propofol 20mg/ml", kcal: "1.33", defaultMl: 0 },
                { name: "Remifentanil", kcal: "0", defaultMl: 0 },
                { name: "Adrenalin", kcal: "0", defaultMl: 0 },
                { name: "Argipressin", kcal: "0", defaultMl: 0 },
                { name: "Dobutamin", kcal: "0", defaultMl: 0 },
                { name: "Levosimendan", kcal: "0.2", defaultMl: 0 },
                { name: "Milrinon", kcal: "0", defaultMl: 0 },
                { name: "Noradrenalin", kcal: "0", defaultMl: 0 },
                { name: "Amiodarone", kcal: "0.2", defaultMl: 0 },
                { name: "EDA", kcal: "0", defaultMl: 0 },
                { name: "Lispro", kcal: "0", defaultMl: 0 }, // Added Lispro
                { name: "Paracetamol", kcal: "0", defaultMl: 0 }
            ],
            "TPN/Sondmat": [
                { name: "Peroralt intag", kcal: "0" }, // Added Peroralt intag
                { name: "Sondmat övrig", kcal: "0" },
                { name: "Smof Kabiven 900 kcal extra nitrogen", kcal: "0.9" },
                { name: "Smof Kabiven 1100 kcal", kcal: "1.12" },
                { name: "Smof Kabiven PI 1300 kcal", kcal: "0.68" },
                { name: "Smof Kabiven 1350 kcal extra nitrogen", kcal: "0.9" },
                { name: "Smof Kabiven 1600 kcal", kcal: "1.08" },
                { name: "Smof Kabiven 1800 extra nitrogen", kcal: "1.1" },
                { name: "Smof Kabiven 2200 kcal", kcal: "1.12" },
                { name: "Sondmat Fresubin 2 kcal HP", kcal: "2.0" },
                { name: "Sondmat Fresubin Original", kcal: "1" },
                { name: "Sondmat Isosource standardfibre", kcal: "1" }
            ]
        };

        // Diagnostisk logg för att se initiala värden vid skriptladdning
        console.log('Script loaded. Initial counters:', {
            fluidEntryCounter,
            medicineEntryCounter,
            bloodProductCounter,
            tpnSondmatEntryCounter,
            lossEntryCounter
        });

        // Hjälpfunktion för att lägga till alternativ i select-menyerna
        function addOptionToSelect(selectElement, value, text, kcalPerMl = null, defaultMl = null, isDisabled = false) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            if (kcalPerMl !== null) {
                option.dataset.kcalPerMl = kcalPerMl.toString();
            }
            if (defaultMl !== null) {
                option.dataset.defaultMl = defaultMl.toString();
            }
            if (isDisabled) {
                option.disabled = true;
            }
            selectElement.appendChild(option);
            return option; // Returnera option-elementet för eventuella ytterligare justeringar
        }

        // Funktion för att lägga till optgroup i select-menyerna
        function addOptgroupToSelect(selectElement, label) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = label;
            selectElement.appendChild(optgroup);
            return optgroup;
        }

        /**
         * Sets the current time in a specified time field.
         * @param {string} elementId - ID of the time field to update.
         */
        window.setNow = function(elementId) { // Exponeras globalt för onclick
            try {
                console.log(`setNow() called for elementId: ${elementId}`);
                const timeInput = document.getElementById(elementId);
                if (!timeInput) {
                    console.warn(`Time input element with ID ${elementId} not found.`);
                    return;
                }
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${minutes}`;

                const event = new Event('input', { bubbles: true });
                timeInput.dispatchEvent(event);
            } catch (error) {
                console.error(`Error in setNow(${elementId}):`, error);
            }
        }

        /**
         * Changes the value in a numeric input field by a given delta.
         * Used by plus and minus buttons.
         * @param {string} elementId - ID of the numeric field to change.
         * @param {number} delta - The value to add (e.g., 1 for plus, -1 for minus).
         */
        window.changeNumber = function(elementId, delta) { // Exponeras globalt för onclick
            try {
                console.log(`changeNumber() called for elementId: ${elementId}, delta: ${delta}`);
                const input = document.getElementById(elementId);
                if (!input) {
                    console.warn(`Number input element with ID ${elementId} not found.`);
                    return;
                }
                let value = parseFloat(input.value);
                if (isNaN(value)) {
                    value = 0;
                }
                input.value = value + delta;
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            } catch (error) {
                console.error(`Error in changeNumber(${elementId}, ${delta}):`, error);
            }
        }

        /**
         * Calculates the duration in hours between two times.
         * Handles crossing midnight for 24-hour periods (e.g., 06:00-06:00).
         * @param {string} startTimeStr - Start time in "HH:MM" format.
         * @param {string} endTimeStr - End time in "HH:MM" format.
         * @returns {number} The duration in hours.
         */
        function calculateDurationInHours(startTimeStr, endTimeStr) {
            try {
                const [startH, startM] = startTimeStr.split(':').map(Number);
                const [endH, endM] = endTimeStr.split(':').map(Number);

                const startMinutes = startH * 60 + startM;
                let endMinutes = endH * 60 + endM;

                if (startMinutes === endMinutes) {
                    return 24;
                }

                if (endMinutes < startMinutes) {
                    endMinutes += 24 * 60;
                }

                return (endMinutes - startMinutes) / 60;
            } catch (error) {
                console.error("Error in calculateDurationInHours:", error);
                return 0;
            }
        }

        /**
         * Calculates Kcal for a specific fluid row (Kristalloider/Kolloider).
         * @param {string|number} rowId - ID of the row to calculate.
         */
        function calculateKcalForEntry(rowId) {
            try {
                const fluidSelect = document.getElementById(`fluidSelect_${rowId}`);
                const mlInput = document.getElementById(`mlInput_${rowId}`);
                const kcalOutput = document.getElementById(`kcalOutput_${rowId}`);

                if (!fluidSelect || !mlInput || !kcalOutput) {
                    console.warn(`Skipping Kcal calculation for fluid row with ID ${rowId} as one or more elements were not found.`);
                    return;
                }

                if (kcalOutput.dataset.manualOverride === 'true' && document.activeElement !== mlInput && document.activeElement !== fluidSelect) {
                    console.log(`Kcal for fluid row ${rowId} is manually overridden.`);
                } else {
                    const selectedOption = fluidSelect.options[fluidSelect.selectedIndex];
                    const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                    const mlValue = parseFloat(mlInput.value || '0');

                    if (!isNaN(mlValue) && !isNaN(kcalPerMl)) {
                        const calculatedKcal = mlValue * kcalPerMl;
                        kcalOutput.value = Math.round(calculatedKcal);
                    } else {
                        kcalOutput.value = '0';
                    }
                    kcalOutput.dataset.manualOverride = 'false';
                }
                calculateTotals();
            } catch (error) {
                console.error(`Error in calculateKcalForEntry(${rowId}):`, error);
            }
        }

        /**
         * Calculates Kcal for a specific medication fluid row.
         * @param {string} rowId - ID of the row to calculate.
         */
        function calculateKcalForMedicineEntry(rowId) {
            try {
                const medicineSelect = document.getElementById(`medicineSelect_${rowId}`);
                const medicineMlInput = document.getElementById(`medicineMlInput_${rowId}`);
                const medicineKcalOutput = document.getElementById(`medicineKcalOutput_${rowId}`);

                if (!medicineSelect || !medicineMlInput || !medicineKcalOutput) {
                    console.warn(`Skipping Kcal calculation for medicine row with ID ${rowId} as one or more elements were not found.`);
                    return;
                }

                if (medicineKcalOutput.dataset.manualOverride === 'true' && document.activeElement !== medicineMlInput && document.activeElement !== medicineSelect) {
                    console.log(`Kcal for medicine row ${rowId} is manually overridden.`);
                } else {
                    const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
                    const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                    const mlValue = parseFloat(medicineMlInput.value || '0');

                    if (!isNaN(mlValue) && !isNaN(kcalPerMl)) {
                        const calculatedKcal = mlValue * kcalPerMl;
                        medicineKcalOutput.value = Math.round(calculatedKcal);
                    } else {
                        medicineKcalOutput.value = '0';
                    }
                    medicineKcalOutput.dataset.manualOverride = 'false';
                }
                calculateTotals();
            } catch (error) {
                console.error(`Error in calculateKcalForMedicineEntry(${rowId}):`, error);
            }
        }

        /**
         * Calculates Kcal for a specific TPN/Sondmat row.
         * @param {string} rowId - ID of the row to calculate.
         */
        function calculateKcalForTpnSondmatEntry(rowId) {
            try {
                const tpnSondmatSelect = document.getElementById(`tpnSondmatSelect_${rowId}`);
                const tpnSondmatMlInput = document.getElementById(`tpnSondmatMlInput_${rowId}`);
                const tpnSondmatKcalOutput = document.getElementById(`tpnSondmatKcalOutput_${rowId}`);

                if (!tpnSondmatSelect || !tpnSondmatMlInput || !tpnSondmatKcalOutput) {
                    console.warn(`Skipping Kcal calculation for TPN/Sondmat row with ID ${rowId} as one or more elements were not found.`);
                    return;
                }

                if (tpnSondmatKcalOutput.dataset.manualOverride === 'true' && document.activeElement !== tpnSondmatMlInput && document.activeElement !== tpnSondmatSelect) {
                    console.log(`Kcal for TPN/Sondmat row ${rowId} is manually overridden.`);
                } else {
                    const selectedOption = tpnSondmatSelect.options[tpnSondmatSelect.selectedIndex];
                    const kcalPerMl = parseFloat(selectedOption.dataset.kcalPerMl || '0');
                    const mlValue = parseFloat(tpnSondmatMlInput.value || '0');

                    if (!isNaN(mlValue) && !isNaN(kcalPerMl)) {
                        const calculatedKcal = mlValue * kcalPerMl;
                        tpnSondmatKcalOutput.value = Math.round(calculatedKcal);
                    } else {
                        tpnSondmatKcalOutput.value = '0';
                    }
                    tpnSondmatKcalOutput.dataset.manualOverride = 'false';
                }
                calculateTotals();
            } catch (error) {
                console.error(`Error in calculateKcalForTpnSondmatEntry(${rowId}):`, error);
            }
        }


        /**
         * Calculates Perspiratio based on daily weight, breathing support, and temperature.
         * This function dynamically updates the calculated Perspiratio output and its label.
         * Changes in daily weight, breathing support, temperature hours, and the start/end times
         * for the calculation period will trigger a recalculation.
         * @param {number} [durationHoursOverride=null] - Optional. If provided, uses this duration instead of calculating from startTime/endTime.
         * @param {number} [dailyWeightOverride=null] - Optional. If provided, uses this weight instead of appState.dailyWeight.
         * @returns {number} Calculated perspiratio in ml.
         */
        function calculatePerspiratio(durationHoursOverride = null, dailyWeightOverride = null) {
            try {
                console.log('calculatePerspiratio() function executed.');
                const dailyWeightInput = document.getElementById('dailyWeight');
                const breathingSupportInput = document.getElementById('breathingSupport'); // Get the DOM element directly
                const temp37HoursInput = document.getElementById('temp37Hours');
                const temp38HoursInput = document.getElementById('temp38Hours');
                const temp39HoursInput = document.getElementById('temp39Hours');
                const temp40HoursInput = document.getElementById('temp40Hours');
                const calculatedPerspiratioOutput = document.getElementById('calculatedPerspiratio');
                const calculatedPerspiratioLabel = document.getElementById('calculatedPerspiratioLabel');
                const startTimeInput = document.getElementById('startTime');
                const endTimeInput = document.getElementById('endTime');


                if (!dailyWeightInput || !breathingSupportInput || !temp37HoursInput || !temp38HoursInput || !temp39HoursInput || !temp40HoursInput || !calculatedPerspiratioOutput || !calculatedPerspiratioLabel || !startTimeInput || !endTimeInput) {
                    console.error("One or more necessary input fields for perspiratio calculation are missing.");
                    return 0; // Return 0 if elements are missing
                }

                // Use overrides if provided, otherwise fall back to appState or input values
                const currentDailyWeight = dailyWeightOverride !== null ? dailyWeightOverride : parseFloat(dailyWeightInput.value);
                // Update appState.dailyWeight here if it's not overridden, to ensure it's current.
                // This is crucial because other parts might rely on appState for calculations.
                appState.dailyWeight = currentDailyWeight;

                const breathingSupport = breathingSupportInput.value; // Read directly from the DOM element
                const temp37Hours = parseFloat(temp37HoursInput.value || '0');
                const temp38Hours = parseFloat(temp38HoursInput.value || '0');
                const temp39Hours = parseFloat(temp39HoursInput.value || '0');
                const temp40Hours = parseFloat(temp40HoursInput.value || '0');

                const startTime = appState.mainAppStartTime;
                const endTime = appState.mainAppEndTime;
                const totalHoursInPeriod = durationHoursOverride !== null ? durationHoursOverride : calculateDurationInHours(startTime, endTime);

                console.log(`Debug - Inputs: dailyWeight=${currentDailyWeight}, breathingSupport=${breathingSupport}, temp37=${temp37Hours}, temp38=${temp38Hours}, temp39=${temp39Hours}, temp40=${temp40Hours}, startTime=${startTime}, endTime=${endTime}, totalHoursInPeriod=${totalHoursInPeriod}`);


                if (isNaN(currentDailyWeight) || currentDailyWeight <= 0) {
                    calculatedPerspiratioOutput.value = "Ange dagens vikt";
                    calculatedPerspiratioLabel.textContent = `Beräknad Perspiratio (ml):`;
                    calculateTotals();
                    console.log("Debug - Daily weight invalid, returning.");
                    return 0;
                }

                if (totalHoursInPeriod <= 0) {
                    calculatedPerspiratioOutput.value = "0 ml";
                    calculatedPerspiratioLabel.textContent = `Beräknad Perspiratio (ml ${startTime}-${endTime}):`;
                    calculateTotals();
                    console.log("Debug - Total hours in period invalid, returning.");
                    return 0;
                }

                let baseRatePerKgPerHour = 0;

                switch (breathingSupport) {
                    case 'none':
                        baseRatePerKgPerHour = 0.5;
                        break;
                    case 'niv_hmef':
                        baseRatePerKgPerHour = 0.55;
                        break;
                    case 'niv_humid':
                        baseRatePerKgPerHour = 0.4;
                        break;
                    case 'hfnc':
                        baseRatePerKgPerHour = 0.3;
                        break;
                    case 'intub_hmef':
                        baseRatePerKgPerHour = 0.75;
                        break;
                    case 'intub_humid':
                        baseRatePerKgPerHour = 0.2;
                        break;
                    default:
                        baseRatePerKgPerHour = 0.5;
                }
                console.log(`Debug - baseRatePerKgPerHour: ${baseRatePerKgPerHour}`);


                let additionalLossPerDegreePerKgPerHour = 0.1;
                console.log(`Debug - additionalLossPerDegreePerKgPerHour: ${additionalLossPerDegreePerKgPerHour}`);


                let totalFeverLoss = 0;
                let coveredHours = 0;

                // Ensure we don't count hours beyond totalHoursInPeriod
                let hoursAt40 = Math.min(temp40Hours, totalHoursInPeriod);
                if (hoursAt40 > 0) {
                    totalFeverLoss += hoursAt40 * (baseRatePerKgPerHour + (40 - 37) * additionalLossPerDegreePerKgPerHour) * currentDailyWeight;
                    coveredHours += hoursAt40;
                    console.log(`Debug - Hours at >40C: ${hoursAt40}, totalFeverLoss now: ${totalFeverLoss}, coveredHours: ${coveredHours}`);
                }

                let hoursAt39 = Math.min(temp39Hours, totalHoursInPeriod - coveredHours);
                if (hoursAt39 > 0) {
                    totalFeverLoss += hoursAt39 * (baseRatePerKgPerHour + (39 - 37) * additionalLossPerDegreePerKgPerHour) * currentDailyWeight;
                    coveredHours += hoursAt39;
                    console.log(`Debug - Hours at >39C: ${hoursAt39}, totalFeverLoss now: ${totalFeverLoss}, coveredHours: ${coveredHours}`);
                }

                let hoursAt38 = Math.min(temp38Hours, totalHoursInPeriod - coveredHours);
                if (hoursAt38 > 0) {
                    totalFeverLoss += hoursAt38 * (baseRatePerKgPerHour + (38 - 37) * additionalLossPerDegreePerKgPerHour) * currentDailyWeight;
                    coveredHours += hoursAt38;
                    console.log(`Debug - Hours at >38C: ${hoursAt38}, totalFeverLoss now: ${totalFeverLoss}, coveredHours: ${coveredHours}`);
                }

                let hoursAt37 = Math.min(temp37Hours, totalHoursInPeriod - coveredHours);
                if (hoursAt37 > 0) {
                    totalFeverLoss += hoursAt37 * (baseRatePerKgPerHour + 0.5 * additionalLossPerDegreePerKgPerHour) * currentDailyWeight; // Adjust for >37 not being a full degree difference
                    coveredHours += hoursAt37;
                    console.log(`Debug - Hours at >37C: ${hoursAt37}, totalFeverLoss now: ${totalFeverLoss}, coveredHours: ${coveredHours}`);
                }

                let hoursAtNormalTemp = totalHoursInPeriod - coveredHours;
                if (hoursAtNormalTemp > 0) {
                    totalFeverLoss += hoursAtNormalTemp * baseRatePerKgPerHour * currentDailyWeight;
                }
                console.log(`Debug - Hours at normal temp: ${hoursAtNormalTemp}, final totalFeverLoss: ${totalFeverLoss}`);

                // Update main app's display if this is the primary call
                if (durationHoursOverride === null && dailyWeightOverride === null) {
                    calculatedPerspiratioOutput.value = Math.round(totalFeverLoss) + " ml";
                    calculatedPerspiratioLabel.textContent = `Beräknad Perspiratio (ml ${startTime}-${endTime}):`;
                    console.log(`Perspiratio label updated to: ${calculatedPerspiratioLabel.textContent}`);
                    calculateTotals(); // Recalculate main app totals
                }

                return Math.round(totalFeverLoss); // Return the calculated value
            } catch (error) {
                console.error("Error in calculatePerspiratio:", error);
                return 0;
            }
        }

        /**
         * Transfers calculated Perspiratio to a loss row.
         */
        window.transferPerspiratioToLoss = function() { // Exponeras globalt för onclick
            try {
                console.log('transferPerspiratioToLoss() called.');
                const calculatedPerspiratioInput = document.getElementById('calculatedPerspiratio');
                if (!calculatedPerspiratioInput) {
                    console.warn("Calculated Perspiratio input element not found.");
                    return;
                }
                const perspiratioValue = parseFloat((calculatedPerspiratioInput.value || '0').replace(' ml', '')) || 0;

                const staticPerspiratioMlInput = document.getElementById('lossMlInput_perspiratio_static');

                if (staticPerspiratioMlInput) {
                    staticPerspiratioMlInput.value = perspiratioValue;
                } else {
                    // This else branch should theoretically not be hit as the static element is always present now.
                    // However, as a fallback, we keep it.
                    createLossEntryRow({ lossType: 'Perspiratio', mlValue: perspiratioValue });
                }
                calculateTotals();
            } catch (error) {
                console.error("Error in transferPerspiratioToLoss:", error);
            }
        }


        /**
         * Performs all calculations based on user input and updates the summary table.
         * This function is called every time a relevant field changes.
         */
        function calculateTotals() {
            try {
                let totalIntakeMl = 0;
                let totalIntakeKcal = 0;
                let totalLossMl = 0;

                // Reset medicine category totals and kcal summary for recalculation
                appState.medicineCategoryTotals = {
                    Sedering: 0,
                    Antibiotika: 0,
                    Vasoaktiva: 0,
                    Övrigt: 0
                };
                appState.kcalSummary = {
                    peroralt: 0,
                    sondmat: 0,
                    tpn: 0,
                    ivMedicine: 0,
                    intravenousTotal: 0 // Will now include Kristalloider/Kolloider
                };

                let kcalFromKristalloiderKolloider = 0; // New variable to track Kcal from Kristalloider/Kolloider specifically

                // Sum up fluids (Kristalloider/Kolloider)
                Array.from(document.querySelectorAll('#fluidEntriesContainer .fluid-entry-row')).forEach(row => {
                    const mlInput = row.querySelector('input[id^="mlInput_"]');
                    const kcalOutput = row.querySelector('input[id^="kcalOutput_"]');
                    const mlValue = parseFloat(mlInput?.value || '0');
                    const kcalValue = parseFloat(kcalOutput?.value || '0');
                    totalIntakeMl += mlValue;
                    totalIntakeKcal += kcalValue;
                    kcalFromKristalloiderKolloider += kcalValue; // Accumulate for the new intravenous total
                });

                // Sum up medicine fluids
                Array.from(document.querySelectorAll('#medicineEntriesContainer .fluid-entry-row')).forEach(row => {
                    const medicineSelect = row.querySelector('select[id^="medicineSelect_"]');
                    const medicineMlInput = row.querySelector('input[id^="medicineMlInput_"]');
                    const medicineKcalOutput = row.querySelector('input[id^="medicineKcalOutput_"]');

                    const mlValue = parseFloat(medicineMlInput?.value || '0');
                    const kcalValue = parseFloat(medicineKcalOutput?.value || '0');

                    totalIntakeMl += mlValue;
                    totalIntakeKcal += kcalValue;
                    appState.kcalSummary.ivMedicine += kcalValue; // Kcal from IV Medicine

                    // Sum up by medicine category
                    const selectedMedicineName = medicineSelect?.value || '';
                    const medicineItem = kcalData["Läkemedelsvätskor"].find(item => item.name === selectedMedicineName);

                    if (medicineItem) {
                        // Determine category for the selected medicine
                        if (["Dexdor", "Esketamin", "Klonidin", "Midazolam", "Propofol 10mg/ml", "Propofol 20mg/ml", "Remifentanil"].includes(selectedMedicineName)) {
                            appState.medicineCategoryTotals.Sedering += mlValue;
                        } else if (["Pip/Taz 4g x 3", "Övrig Antibiotika", "Kaspofungin"].includes(selectedMedicineName)) {
                            appState.medicineCategoryTotals.Antibiotika += mlValue;
                        } else if (["Adrenalin", "Argipressin", "Dobutamin", "Levosimendan", "Milrinon", "Noradrenalin"].includes(selectedMedicineName)) {
                            appState.medicineCategoryTotals.Vasoaktiva += mlValue;
                        } else {
                            appState.medicineCategoryTotals.Övrigt += mlValue; // Catches "Övrigt läkemedel", "Amiodarone", "EDA", "Lispro", "Paracetamol"
                        }
                    } else if (selectedMedicineName === 'Övrigt läkemedel') {
                        appState.medicineCategoryTotals.Övrigt += mlValue; // Handle custom "Övrigt läkemedel"
                    }
                });

                // Sum up blood products
                Array.from(document.querySelectorAll('#bloodProductEntriesContainer .blood-product-entry-row')).forEach(row => {
                    const mlInput = row.querySelector('input[id^="bloodProductMlInput_"]');
                    totalIntakeMl += parseFloat(mlInput?.value || '0');
                });

                // Sum up TPN/Sondmat/Peroralt
                Array.from(document.querySelectorAll('#tpnSondmatEntriesContainer .tpn-sondmat-entry-row')).forEach(row => {
                    const tpnSondmatSelect = row.querySelector('select[id^="tpnSondmatSelect_"]');
                    const tpnSondmatMlInput = row.querySelector('input[id^="tpnSondmatMlInput_"]');
                    const tpnSondmatKcalOutput = row.querySelector('input[id^="tpnSondmatKcalOutput_"]');

                    const mlValue = parseFloat(tpnSondmatMlInput?.value || '0');
                    const kcalValue = parseFloat(tpnSondmatKcalOutput?.value || '0');

                    totalIntakeMl += mlValue;
                    totalIntakeKcal += kcalValue;

                    if (tpnSondmatSelect && tpnSondmatSelect.value === 'Peroralt intag') {
                        appState.kcalSummary.peroralt += kcalValue; // Kcal from Peroralt
                    } else if (tpnSondmatSelect && tpnSondmatSelect.value.startsWith('Sondmat')) { // "Sondmat övrig", "Sondmat Fresubin...", "Sondmat Isosource..."
                        appState.kcalSummary.sondmat += kcalValue; // Kcal from Sondmat
                    } else { // Assume TPN for other categories
                        appState.kcalSummary.tpn += kcalValue; // Kcal from TPN
                    }
                });

                // Now calculate the combined total for IV Medicine, TPN, and Kristalloider/Kolloider
                appState.kcalSummary.intravenousTotal = appState.kcalSummary.ivMedicine + appState.kcalSummary.tpn + kcalFromKristalloiderKolloider;


                // Add NaCl syringes to total intake
                const naclSyringesCount = parseFloat(document.getElementById('naclSyringes')?.value || '0');
                totalIntakeMl += naclSyringesCount * 10; // Each syringe is 10ml

                // Add pressure sets to total intake
                const pressureSetsCount = parseFloat(document.getElementById('pressureSets')?.value || '0');
                const startTime = document.getElementById('startTime')?.value || '06:00';
                const endTime = document.getElementById('endTime')?.value || '06:00';
                const totalHoursInPeriod = calculateDurationInHours(startTime, endTime);
                totalIntakeMl += pressureSetsCount * 3 * totalHoursInPeriod; // 3ml/hour per pressure set

                let currentTotalDiuresisMl = 0;
                let currentTotalPerspiratioMl = 0;
                let currentTotalOtherLossMl = 0; // Losses excluding Diuresis and Perspiratio

                // Sum up losses and categorize
                Array.from(document.querySelectorAll('#lossEntriesContainer .loss-entry-row')).forEach(row => {
                    const lossSelect = row.querySelector('select[id^="lossSelect_"]');
                    const lossMlInput = row.querySelector('input[id^="lossMlInput_"]');
                    const mlValue = parseFloat(lossMlInput?.value || '0');

                    if (lossSelect && lossSelect.value === 'Diures') {
                        currentTotalDiuresisMl += mlValue;
                    } else if (lossSelect && lossSelect.value === 'Perspiratio') {
                        currentTotalPerspiratioMl += mlValue;
                    } else {
                        currentTotalOtherLossMl += mlValue;
                    }
                    totalLossMl += mlValue; // Overall total loss
                });

                // Get cumulative balance from previous day
                const cumulativeBalancePrev = parseFloat(document.getElementById('cumulativeBalancePrev')?.value || '0');

                // Calculate Net Balance
                const netBalance = totalIntakeMl - totalLossMl;

                // Calculate Cumulative Balance
                const finalCumulativeBalance = cumulativeBalancePrev + netBalance;

                // Calculate Weight Difference
                let weightDifference = 0;
                const initialWeight = parseFloat(document.getElementById('initialWeight')?.value || '0');
                const dailyWeight = parseFloat(document.getElementById('dailyWeight')?.value || '0');

                if (!isNaN(initialWeight) && !isNaN(dailyWeight) && initialWeight !== 0) { // Only calculate if initial weight is provided and not zero
                    weightDifference = dailyWeight - initialWeight;
                }

                // Update appState with calculated values
                appState.totalIntakeMl = totalIntakeMl;
                appState.totalIntakeKcal = totalIntakeKcal;
                appState.totalLossMl = totalLossMl;
                appState.netBalanceMl = netBalance;
                appState.cumulativeBalanceMl = finalCumulativeBalance;
                appState.weightDifferenceKg = weightDifference;
                appState.totalDiuresisMl = currentTotalDiuresisMl;
                appState.totalPerspiratioMl = currentTotalPerspiratioMl;
                appState.totalOtherLossMl = currentTotalOtherLossMl;

                // Update appState with patient info and temp settings for diuresis calculator
                appState.dailyWeight = dailyWeight; // Ensure this is updated for perspiratio
                appState.height = parseFloat(document.getElementById('height')?.value || '0');
                appState.gender = document.getElementById('gender')?.value || '';
                appState.breathingSupport = document.getElementById('breathingSupport')?.value || 'none';
                appState.temp37Hours = parseFloat(document.getElementById('temp37Hours')?.value || '0');
                appState.temp38Hours = parseFloat(document.getElementById('temp38Hours')?.value || '0');
                appState.temp39Hours = parseFloat(document.getElementById('temp39Hours')?.value || '0');
                appState.temp40Hours = parseFloat(document.getElementById('temp40Hours')?.value || '0');
                appState.mainAppStartTime = document.getElementById('startTime')?.value || '06:00';
                appState.mainAppEndTime = document.getElementById('endTime')?.value || '06:00';

                // Store patient info for print modal
                appState.patientDate = document.getElementById('dateInput')?.value || '';
                appState.patientTimePeriod = `${document.getElementById('startTime')?.value || '06:00'} - ${document.getElementById('endTime')?.value || '06:00'}`;
                appState.patientLocation = document.getElementById('bedSelect')?.value === 'Annan plats' ? (document.getElementById('otherLocationInput')?.value || '') : (document.getElementById('bedSelect')?.value || '');
                appState.initialWeight = initialWeight;
                appState.idealWeight = parseFloat(document.getElementById('idealWeight')?.value || '0'); // Get from the displayed ideal weight
                appState.adjustedWeight = document.getElementById('adjustedWeightNotice')?.style.display === 'inline'; // Check if adjusted notice is visible


                // Update summary table in main app
                const totalIntakeMlElement = document.getElementById('totalIntakeMl');
                const totalIntakeKcalElement = document.getElementById('totalIntakeKcal');
                const totalLossMlElement = document.getElementById('totalLossMl');
                const netBalanceMlElement = document.getElementById('netBalanceMl');
                const cumulativeBalanceMlElement = document.getElementById('cumulativeBalanceMl');
                const weightDifferenceKgElement = document.getElementById('weightDifferenceKg');

                if (totalIntakeMlElement) totalIntakeMlElement.textContent = Math.round(appState.totalIntakeMl).toString();
                if (totalIntakeKcalElement) totalIntakeKcalElement.textContent = Math.round(appState.totalIntakeKcal).toString();
                if (totalLossMlElement) totalLossMlElement.textContent = Math.round(appState.totalLossMl).toString();
                if (netBalanceMlElement) netBalanceMlElement.textContent = Math.round(appState.netBalanceMl).toString();
                if (cumulativeBalanceMlElement) cumulativeBalanceMlElement.textContent = Math.round(appState.cumulativeBalanceMl).toString();
                if (weightDifferenceKgElement) weightDifferenceKgElement.textContent = appState.weightDifferenceKg.toFixed(1);

                // Log all relevant appState values for debugging
                console.log('appState after calculateTotals:', appState);

            } catch (error) {
                console.error("Error in calculateTotals:", error);
            }
        }

        // --- Initial population of static select elements helper functions ---
        function populateFluidSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            addOptionToSelect(selectElement, '', 'Välj vätska');

            const fluidItems = kcalData["Kristalloider/Kolloider"];

            const categories = {
                "Glucos utan elektrolyter": ["Glukos 25 mg/ml", "Glukos 50 mg/ml", "Glukos 100 mg/ml", "Glukos 200 mg/ml", "Glukos 300 mg/ml"],
                "Kolloider": ["Albumin 20%", "Albumin 5%"],
                "Kristalloider med elektrolyter": ["Glukos 100 mg/ml med el", "Glukos 50 mg/ml med El", "NaCl Picco-Kalibrering", "Natriumbikarbonat 50 mg/ml", "Natriumklorid 9 mg/ml", "Natriumklorid hyperton", "Plasmolyte", "Ringer-Acetat"]
            };

            // Add 'Övrig vätska' as a base option first
            const otherFluidItem = fluidItems.find(item => item.name === "Övrig vätska");
            if (otherFluidItem) {
                addOptionToSelect(selectElement, otherFluidItem.name, otherFluidItem.name, parseFloat(otherFluidItem.kcal));
            }

            for (const categoryLabel in categories) {
                const optgroup = addOptgroupToSelect(selectElement, categoryLabel);
                categories[categoryLabel].forEach(fluidName => {
                    const item = fluidItems.find(d => d.name === fluidName);
                    if (item) {
                        addOptionToSelect(optgroup, item.name, item.name, parseFloat(item.kcal));
                    }
                });
            }
        }

        function populateMedicineSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            addOptionToSelect(selectElement, '', 'Välj läkemedelsvätska');

            const medicineItems = kcalData["Läkemedelsvätskor"];

            const categories = {
                "Sedering": ["Dexdor", "Esketamin", "Klonidin", "Midazolam", "Propofol 10mg/ml", "Propofol 20mg/ml", "Remifentanil"],
                "Antibiotika": ["Pip/Taz 4g x 3", "Övrig Antibiotika", "Kaspofungin"],
                "Vasoaktiva": ["Adrenalin", "Argipressin", "Dobutamin", "Levosimendan", "Milrinon", "Noradrenalin"],
                "Övrigt": ["Amiodarone", "EDA", "Lispro", "Paracetamol"] // Lispro added here
            };

            // Add 'Övrigt läkemedel' as a base option first
            const otherMedicineItem = medicineItems.find(item => item.name === "Övrigt läkemedel");
            if (otherMedicineItem) {
                addOptionToSelect(selectElement, otherMedicineItem.name, otherMedicineItem.name, parseFloat(otherMedicineItem.kcal), otherMedicineItem.defaultMl);
            }

            for (const categoryLabel in categories) {
                const optgroup = addOptgroupToSelect(selectElement, categoryLabel);
                categories[categoryLabel].forEach(medicineName => {
                    const item = medicineItems.find(d => d.name === medicineName);
                    if (item) {
                        addOptionToSelect(optgroup, item.name, item.name, parseFloat(item.kcal), item.defaultMl);
                    }
                });
            }
        }

        function populateBloodProductSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            addOptionToSelect(selectElement, '', 'Välj blodprodukt');
            addOptionToSelect(selectElement, 'Erytrocyter', 'Erytrocyter');
            addOptionToSelect(selectElement, 'Trombocyter', 'Trombocyter');
            addOptionToSelect(selectElement, 'Plasma', 'Plasma');
        }

        function populateTpnSondmatSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            addOptionToSelect(selectElement, '', 'Välj TPN/Sondmat/Peroralt'); // Changed placeholder

            // Add "Peroralt intag" first, before others
            addOptionToSelect(selectElement, 'Peroralt intag', 'Peroralt intag', 0);

            const tpnSondmatItems = kcalData["TPN/Sondmat"];

            const categories = {
                "TPN/Sondmat": [ // This is the main category for these items
                    "Sondmat övrig", // Moved here
                    "Smof Kabiven 900 kcal extra nitrogen",
                    "Smof Kabiven 1100 kcal",
                    "Smof Kabiven PI 1300 kcal",
                    "Smof Kabiven 1350 kcal extra nitrogen",
                    "Smof Kabiven 1600 kcal",
                    "Smof Kabiven 1800 extra nitrogen",
                    "Smof Kabiven 2200 kcal",
                    "Sondmat Fresubin 2 kcal HP",
                    "Sondmat Fresubin Original",
                    "Sondmat Isosource standardfibre"
                ]
            };

            // Add 'Sondmat övrig' as a base option first IF NOT ALREADY ADDED AS A CATEGORY ITEM
            const otherTpnSondmatItem = tpnSondmatItems.find(item => item.name === "Sondmat övrig");
            if (otherTpnSondmatItem && !categories["TPN/Sondmat"].includes("Sondmat övrig")) {
                addOptionToSelect(selectElement, otherTpnSondmatItem.name, otherTpnSondmatItem.name, parseFloat(otherTpnSondmatItem.kcal));
            }


            for (const categoryLabel in categories) {
                const optgroup = addOptgroupToSelect(selectElement, categoryLabel);
                categories[categoryLabel].forEach(tpnSondmatName => {
                    const item = tpnSondmatItems.find(d => d.name === tpnSondmatName);
                    if (item) {
                        addOptionToSelect(optgroup, item.name, item.name, parseFloat(item.kcal));
                    }
                });
            }
        }

        function populateLossSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            addOptionToSelect(selectElement, '', 'Välj förlusttyp');
            addOptionToSelect(selectElement, 'Annan förlust', 'Annan förlust');
            addOptionToSelect(selectElement, 'Diures', 'Diures');
            addOptionToSelect(selectElement, 'Avföring', 'Avföring');
            addOptionToSelect(selectElement, 'Dialys (CRRT)', 'Dialys (CRRT)');
            addOptionToSelect(selectElement, 'Dialys (IHD)', 'Dialys (IHD)');
            addOptionToSelect(selectElement, 'Drän 1', 'Drän 1');
            addOptionToSelect(selectElement, 'Drän 2', 'Drän 2');
            addOptionToSelect(selectElement, 'Drän 3', 'Drän 3');
            addOptionToSelect(selectElement, 'Sond', 'Sond');
            addOptionToSelect(selectElement, 'Stomi', 'Stomi');
            addOptionToSelect(selectElement, 'Thoraxdrän hö', 'Thoraxdrän hö');
            addOptionToSelect(selectElement, 'Thoraxdrän vä', 'Thoraxdrän vä');
        }


        // Functions to create new rows
        function createFluidEntryRow(initialValues = {}) {
            console.log('createFluidEntryRow() executed.');
            fluidEntryCounter++;
            const rowId = fluidEntryCounter;

            const newRow = document.createElement('div');
            newRow.classList.add('fluid-entry-row');
            newRow.dataset.rowId = rowId;

            const gridItem1 = document.createElement('div');
            gridItem1.classList.add('grid-item');

            const fluidSelect = document.createElement('select');
            fluidSelect.id = `fluidSelect_${rowId}`;
            populateFluidSelect(fluidSelect); // Populate using the helper function

            const customFluidInput = document.createElement('input');
            customFluidInput.type = 'text';
            customFluidInput.id = `customFluidInput_${rowId}`;
            customFluidInput.classList.add('custom-fluid-input');
            customFluidInput.placeholder = 'Ange övrig vätska';
            customFluidInput.style.display = 'none';

            gridItem1.appendChild(fluidSelect);
            gridItem1.appendChild(customFluidInput);
            newRow.appendChild(gridItem1);

            const gridItem2 = document.createElement('div');
            gridItem2.classList.add('grid-item');
            const mlInput = document.createElement('input');
            mlInput.type = 'number';
            mlInput.id = `mlInput_${rowId}`;
            mlInput.step = '1';
            mlInput.value = '0';
            gridItem2.appendChild(mlInput);
            newRow.appendChild(gridItem2);

            const gridItem3 = document.createElement('div');
            gridItem3.classList.add('grid-item');
            const kcalOutput = document.createElement('input');
            kcalOutput.type = 'number';
            kcalOutput.id = `kcalOutput_${rowId}`;
            kcalOutput.step = '1';
            kcalOutput.value = '0';
            kcalOutput.classList.add('calculated-output');
            gridItem3.appendChild(kcalOutput);
            newRow.appendChild(gridItem3);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-fluid-button');
            removeButton.dataset.rowId = rowId;
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            newRow.appendChild(removeButton);


            fluidSelect.addEventListener('change', () => {
                console.log(`Fluid select ${fluidSelect.id} changed.`);
                if (fluidSelect.value === 'Övrig vätska') {
                    customFluidInput.style.display = 'block';
                    customFluidInput.focus();
                } else {
                    customFluidInput.style.display = 'none';
                    customFluidInput.value = '';
                }
                calculateKcalForEntry(rowId);
            });
            mlInput.addEventListener('input', () => {
                console.log(`Fluid ML input ${mlInput.id} changed.`);
                calculateKcalForEntry(rowId);
            });
            customFluidInput.addEventListener('input', () => {
                console.log(`Custom fluid input ${customFluidInput.id} changed.`);
                calculateTotals();
            });
            kcalOutput.addEventListener('input', () => {
                console.log(`Kcal output ${kcalOutput.id} changed.`);
                kcalOutput.dataset.manualOverride = 'true';
                calculateTotals();
            });

            removeButton.addEventListener('click', function() {
                console.log(`Remove fluid button ${this.dataset.rowId} clicked.`);
                newRow.remove();
                calculateTotals();
            });

            if (initialValues.fluid) {
                fluidSelect.value = initialValues.fluid;
                if (initialValues.fluid === 'Övrig vätska' && initialValues.customFluidName) {
                    customFluidInput.style.display = 'block';
                    customFluidInput.value = initialValues.customFluidName;
                }
            }

            const fluidEntriesContainer = document.getElementById('fluidEntriesContainer');
            if (fluidEntriesContainer) {
                fluidEntriesContainer.appendChild(newRow);
                calculateKcalForEntry(rowId);
            }
            return newRow;
        }

        function createMedicineEntryRow(initialValues = {}) {
            console.log('createMedicineEntryRow() executed.');
            medicineEntryCounter++;
            const rowId = `med_${medicineEntryCounter}`;

            const newRow = document.createElement('div');
            newRow.classList.add('fluid-entry-row');
            newRow.dataset.rowId = rowId;

            const gridItem1 = document.createElement('div');
            gridItem1.classList.add('grid-item');

            const medicineSelect = document.createElement('select');
            medicineSelect.id = `medicineSelect_${rowId}`;
            populateMedicineSelect(medicineSelect); // Populate using the helper function

            const customMedicineInput = document.createElement('input');
            customMedicineInput.type = 'text';
            customMedicineInput.id = `customMedicineInput_${rowId}`;
            customMedicineInput.classList.add('custom-fluid-input');
            customMedicineInput.placeholder = 'Ange övrigt läkemedel';
            customMedicineInput.style.display = 'none';

            gridItem1.appendChild(medicineSelect);
            gridItem1.appendChild(customMedicineInput);
            newRow.appendChild(gridItem1);

            const gridItem2 = document.createElement('div');
            gridItem2.classList.add('grid-item');
            const medicineMlInput = document.createElement('input');
            medicineMlInput.type = 'number';
            medicineMlInput.id = `medicineMlInput_${rowId}`;
            medicineMlInput.step = '1';
            medicineMlInput.value = '0';
            gridItem2.appendChild(medicineMlInput);
            newRow.appendChild(gridItem2);

            const gridItem3 = document.createElement('div');
            gridItem3.classList.add('grid-item');
            const medicineKcalOutput = document.createElement('input');
            medicineKcalOutput.type = 'number';
            medicineKcalOutput.id = `medicineKcalOutput_${rowId}`;
            medicineKcalOutput.step = '1';
            medicineKcalOutput.value = '0';
            medicineKcalOutput.classList.add('calculated-output');
            gridItem3.appendChild(medicineKcalOutput);
            newRow.appendChild(gridItem3);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-fluid-button');
            removeButton.dataset.rowId = rowId;
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            newRow.appendChild(removeButton);

            medicineSelect.addEventListener('change', () => {
                console.log(`Medicine select ${medicineSelect.id} changed.`);
                const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
                const defaultMl = parseFloat(selectedOption.dataset.defaultMl || '0');
                if (defaultMl > 0) {
                    medicineMlInput.value = defaultMl;
                } else if (medicineMlInput.value !== '0' && medicineMlInput.value !== '') {
                } else {
                    medicineMlInput.value = 0;
                }

                if (medicineSelect.value === 'Övrigt läkemedel' || medicineSelect.value === 'Övrig Antibiotika') {
                    customMedicineInput.style.display = 'block';
                    customMedicineInput.focus();
                    customMedicineInput.placeholder = (medicineSelect.value === 'Övrig Antibiotika') ? 'Ange övrig antibiotika' : 'Ange övrigt läkemedel';
                } else {
                    customMedicineInput.style.display = 'none';
                    customMedicineInput.value = '';
                }
                calculateKcalForMedicineEntry(rowId);
            });

            medicineMlInput.addEventListener('input', () => {
                console.log(`Medicine ML input ${medicineMlInput.id} changed.`);
                calculateKcalForMedicineEntry(rowId);
            });
            customMedicineInput.addEventListener('input', () => {
                console.log(`Custom medicine input ${customMedicineInput.id} changed.`);
                calculateTotals();
            });
            medicineKcalOutput.addEventListener('input', () => {
                console.log(`Medicine Kcal output ${medicineKcalOutput.id} changed.`);
                medicineKcalOutput.dataset.manualOverride = 'true';
                calculateTotals();
            });

            removeButton.addEventListener('click', function() {
                console.log(`Remove medicine button ${this.dataset.rowId} clicked.`);
                newRow.remove();
                calculateTotals();
            });

            if (initialValues.medicine) {
                medicineSelect.value = initialValues.medicine;
                if ((initialValues.medicine === 'Övrigt läkemedel' || initialValues.medicine === 'Övrig Antibiotika') && initialValues.customMedicineName) {
                    customMedicineInput.style.display = 'block';
                    customMedicineInput.value = initialValues.customMedicineName;
                    customMedicineInput.placeholder = (initialValues.medicine === 'Övrig Antibiotika') ? 'Ange övrig antibiotika' : 'Ange övrigt läkemedel';
                }
            }

            const medicineEntriesContainer = document.getElementById('medicineEntriesContainer');
            if (medicineEntriesContainer) {
                medicineEntriesContainer.appendChild(newRow);
                calculateKcalForMedicineEntry(rowId);
            }
            return newRow;
        }

        function createBloodProductEntryRow(initialValues = {}) {
            console.log('createBloodProductEntryRow() executed.');
            bloodProductCounter++;
            const rowId = `blood_${bloodProductCounter}`;

            const newRow = document.createElement('div');
            newRow.classList.add('blood-product-entry-row');
            newRow.dataset.rowId = rowId;

            const gridItem1 = document.createElement('div');
            gridItem1.classList.add('grid-item');

            const bloodProductSelect = document.createElement('select');
            bloodProductSelect.id = `bloodProductSelect_${rowId}`;
            populateBloodProductSelect(bloodProductSelect); // Populate using the helper function

            gridItem1.appendChild(bloodProductSelect);
            newRow.appendChild(gridItem1);

            const gridItem2 = document.createElement('div');
            gridItem2.classList.add('grid-item');
            const bloodProductMlInput = document.createElement('input');
            bloodProductMlInput.type = 'number';
            bloodProductMlInput.id = `bloodProductMlInput_${rowId}`;
            bloodProductMlInput.step = '1';
            bloodProductMlInput.value = '0';
            gridItem2.appendChild(bloodProductMlInput);
            newRow.appendChild(gridItem2);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-fluid-button');
            removeButton.dataset.rowId = rowId;
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            newRow.appendChild(removeButton);

            bloodProductSelect.addEventListener('change', () => {
                console.log(`Blood product select ${bloodProductSelect.id} changed.`);
                calculateTotals();
            });
            bloodProductMlInput.addEventListener('input', () => {
                console.log(`Blood product ML input ${bloodProductMlInput.id} changed.`);
                calculateTotals();
            });

            removeButton.addEventListener('click', function() {
                console.log(`Remove blood product button ${this.dataset.rowId} clicked.`);
                newRow.remove();
                calculateTotals();
            });

            if (initialValues.product) {
                bloodProductSelect.value = initialValues.product;
            }

            const bloodProductEntriesContainer = document.getElementById('bloodProductEntriesContainer');
            if (bloodProductEntriesContainer) {
                bloodProductEntriesContainer.appendChild(newRow);
                calculateTotals();
            }
            return newRow;
        }

        function createTpnSondmatEntryRow(initialValues = {}) {
            console.log('createTpnSondmatEntryRow() executed.');
            tpnSondmatEntryCounter++;
            const rowId = `tpn_${tpnSondmatEntryCounter}`;

            const newRow = document.createElement('div');
            newRow.classList.add('tpn-sondmat-entry-row');
            newRow.dataset.rowId = rowId;

            const gridItem1 = document.createElement('div');
            gridItem1.classList.add('grid-item');

            const tpnSondmatSelect = document.createElement('select');
            tpnSondmatSelect.id = `tpnSondmatSelect_${rowId}`;
            populateTpnSondmatSelect(tpnSondmatSelect); // Populate using the helper function

            const customTpnSondmatInput = document.createElement('input');
            customTpnSondmatInput.type = 'text';
            customTpnSondmatInput.id = `customTpnSondmatInput_${rowId}`;
            customTpnSondmatInput.classList.add('custom-fluid-input');
            customTpnSondmatInput.placeholder = 'Ange övrig sondmat';
            customTpnSondmatInput.style.display = 'none';

            gridItem1.appendChild(tpnSondmatSelect);
            gridItem1.appendChild(customTpnSondmatInput);
            newRow.appendChild(gridItem1);

            const gridItem2 = document.createElement('div');
            gridItem2.classList.add('grid-item');
            const tpnSondmatMlInput = document.createElement('input');
            tpnSondmatMlInput.type = 'number';
            tpnSondmatMlInput.id = `tpnSondmatMlInput_${rowId}`;
            tpnSondmatMlInput.step = '1';
            tpnSondmatMlInput.value = '0';
            gridItem2.appendChild(tpnSondmatMlInput);
            newRow.appendChild(gridItem2);

            const gridItem3 = document.createElement('div');
            gridItem3.classList.add('grid-item');
            const tpnSondmatKcalOutput = document.createElement('input');
            tpnSondmatKcalOutput.type = 'number';
            tpnSondmatKcalOutput.id = `tpnSondmatKcalOutput_${rowId}`;
            tpnSondmatKcalOutput.step = '1';
            tpnSondmatKcalOutput.value = '0';
            tpnSondmatKcalOutput.classList.add('calculated-output');
            gridItem3.appendChild(tpnSondmatKcalOutput);
            newRow.appendChild(gridItem3);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-fluid-button');
            removeButton.dataset.rowId = rowId;
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            newRow.appendChild(removeButton);

            tpnSondmatSelect.addEventListener('change', () => {
                console.log(`TPN/Sondmat select ${tpnSondmatSelect.id} changed.`);
                // ONLY show custom input for 'Sondmat övrig'
                if (tpnSondmatSelect.value === 'Sondmat övrig') {
                    customTpnSondmatInput.style.display = 'block';
                    customTpnSondmatInput.focus();
                    customTpnSondmatInput.placeholder = 'Ange övrig sondmat';
                } else {
                    customTpnSondmatInput.style.display = 'none';
                    customTpnSondmatInput.value = '';
                }
                calculateKcalForTpnSondmatEntry(rowId);
            });

            tpnSondmatMlInput.addEventListener('input', () => {
                console.log(`TPN/Sondmat ML input ${tpnSondmatMlInput.id} changed.`);
                calculateKcalForTpnSondmatEntry(rowId);
            });
            customTpnSondmatInput.addEventListener('input', () => {
                console.log(`Custom TPN/Sondmat input ${customTpnSondmatInput.id} changed.`);
                calculateTotals();
            });
            tpnSondmatKcalOutput.addEventListener('input', () => {
                console.log(`TPN/Sondmat Kcal output ${tpnSondmatKcalOutput.id} changed.`);
                tpnSondmatKcalOutput.dataset.manualOverride = 'true';
                calculateTotals();
            });

            removeButton.addEventListener('click', function() {
                console.log(`Remove TPN/Sondmat button ${this.dataset.rowId} clicked.`);
                newRow.remove();
                calculateTotals();
            });

            if (initialValues.tpnSondmat) {
                tpnSondmatSelect.value = initialValues.tpnSondmat;
                // Only show custom input if it's 'Sondmat övrig' AND there was a custom name
                if (initialValues.tpnSondmat === 'Sondmat övrig' && initialValues.customTpnSondmatName) {
                    customTpnSondmatInput.style.display = 'block';
                    customTpnSondmatInput.value = initialValues.customTpnSondmatName;
                    customTpnSondmatInput.placeholder = 'Ange övrig sondmat';
                }
            }

            const tpnSondmatEntriesContainer = document.getElementById('tpnSondmatEntriesContainer');
            if (tpnSondmatEntriesContainer) {
                tpnSondmatEntriesContainer.appendChild(newRow);
                calculateKcalForTpnSondmatEntry(rowId);
            }
            return newRow;
        }

        function createLossEntryRow(initialValues = {}) {
            console.log('createLossEntryRow() executed.');
            lossEntryCounter++;
            const rowId = `loss_${lossEntryCounter}`;

            const newRow = document.createElement('div');
            newRow.classList.add('loss-entry-row');
            newRow.dataset.rowId = rowId;

            const gridItem1 = document.createElement('div');
            gridItem1.classList.add('grid-item');

            const lossSelect = document.createElement('select');
            lossSelect.id = `lossSelect_${rowId}`;
            populateLossSelect(lossSelect); // Populate using the helper function

            const customLossInput = document.createElement('input');
            customLossInput.type = 'text';
            customLossInput.id = `customLossInput_${rowId}`;
            customLossInput.classList.add('custom-fluid-input');
            customLossInput.placeholder = 'Ange annan förlust';
            customLossInput.style.display = 'none';

            gridItem1.appendChild(lossSelect);
            gridItem1.appendChild(customLossInput);
            newRow.appendChild(gridItem1);

            const gridItem2 = document.createElement('div');
            gridItem2.classList.add('grid-item');
            const lossMlInput = document.createElement('input');
            lossMlInput.type = 'number';
            lossMlInput.id = `lossMlInput_${rowId}`;
            lossMlInput.step = '1';
            lossMlInput.value = (initialValues.mlValue || 0);
            gridItem2.appendChild(lossMlInput);
            newRow.appendChild(gridItem2);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-fluid-button');
            removeButton.dataset.rowId = rowId;
            removeButton.innerHTML = '<i class="fas fa-trash"></i>';
            newRow.appendChild(removeButton);

            lossSelect.addEventListener('change', () => {
                console.log(`Loss select ${lossSelect.id} changed.`);
                if (lossSelect.value === 'Annan förlust') {
                    customLossInput.style.display = 'block';
                    customLossInput.focus();
                } else {
                    customLossInput.style.display = 'none';
                    customLossInput.value = '';
                }
                calculateTotals();
            });
            lossMlInput.addEventListener('input', () => {
                console.log(`Loss ML input ${lossMlInput.id} changed.`);
                calculateTotals();
            });
            customLossInput.addEventListener('input', () => {
                console.log(`Custom loss input ${customLossInput.id} changed.`);
                calculateTotals();
            });

            removeButton.addEventListener('click', function() {
                console.log(`Remove loss button ${this.dataset.rowId} clicked.`);
                newRow.remove();
                calculateTotals();
            });

            if (initialValues.lossType) {
                lossSelect.value = initialValues.lossType;
                if (initialValues.lossType === 'Annan förlust' && initialValues.customLossName) {
                    customLossInput.style.display = 'block';
                    customLossInput.value = initialValues.customLossName;
                }
            }

            const lossEntriesContainer = document.getElementById('lossEntriesContainer');
            if (lossEntriesContainer) {
                lossEntriesContainer.appendChild(newRow);
                calculateTotals();
            }
            return newRow;
        }

        // Function to populate the Kcal tables within the modal
        function populateKcalTableInModal() {
            try {
                // Clear existing content in case modal is reopened
                const kcalKristalloiderContainer = document.getElementById('kcalKristalloiderContainer');
                const kcalMedicineContainer = document.getElementById('kcalMedicineContainer');
                const kcalTpnSondmatContainer = document.getElementById('kcalTpnSondmatContainer');

                if (kcalKristalloiderContainer) kcalKristalloiderContainer.innerHTML = '';
                if (kcalMedicineContainer) kcalMedicineContainer.innerHTML = '';
                if (kcalTpnSondmatContainer) kcalTpnSondmatContainer.innerHTML = '';

                const containers = {
                    "Kristalloider/Kolloider": kcalKristalloiderContainer,
                    "Läkemedelsvätskor": kcalMedicineContainer,
                    "TPN/Sondmat": kcalTpnSondmatContainer
                };

                for (const category in kcalData) {
                    const container = containers[category];
                    if (container) {
                        const title = document.createElement('h3');
                        title.textContent = `Kaloriinnehåll ${category}`; // E.g., "Kaloriinnehåll Kristalloider/Kolloider"
                        container.appendChild(title);

                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        const tbody = document.createElement('tbody');
                        const headerRow = document.createElement('tr');
                        const th1 = document.createElement('th');
                        th1.textContent = 'Vätska/Produkt';
                        th1.style.textAlign = 'left';
                        th1.style.padding = '4px';
                        th1.style.borderBottom = '1px solid #ddd';
                        const th2 = document.createElement('th');
                        th2.textContent = 'Kcal/ml';
                        th2.style.textAlign = 'right';
                        th2.style.padding = '4px';
                        th2.style.borderBottom = '1px solid #ddd';

                        headerRow.appendChild(th1);
                        headerRow.appendChild(th2);
                        thead.appendChild(headerRow);
                        table.appendChild(thead);
                        table.appendChild(tbody);

                        kcalData[category].forEach(item => {
                            const row = document.createElement('tr');
                            const td1 = document.createElement('td');
                            td1.textContent = item.name;
                            td1.style.padding = '4px';
                            const td2 = document.createElement('td');
                            td2.textContent = item.kcal;
                            td2.style.textAlign = 'right';
                            td2.style.padding = '4px';
                            row.appendChild(td1);
                            row.appendChild(td2);
                            tbody.appendChild(row);
                        });
                        container.appendChild(table);
                    }
                }
            } catch (error) {
                console.error("Error populating Kcal table in modal:", error);
            }
        }

        // Function to close the modal
        window.closeCalculationsModal = function() {
            console.log('Close Calculations modal function called.');
            const calculationsModalOverlay = document.getElementById('calculationsModalOverlay');
            if (calculationsModalOverlay) {
                calculationsModalOverlay.classList.remove('active');
                document.body.classList.remove('modal-open'); // Remove class from body to allow scrolling
            }
        };

        // --- Diuresis Calculator Functions ---

        /**
         * Opens the Diuresis Calculator modal and populates initial values.
         */
        window.openDiuresisCalculator = function() {
            console.log('Opening Diuresis Calculator modal.');
            const diuresisCalcModal = document.getElementById('diuresisCalculatorModalOverlay');
            if (diuresisCalcModal) {
                diuresisCalcModal.classList.add('active');
                document.body.classList.add('modal-open'); // Prevent scrolling on main body

                // Set current time for 'Beräkning från klockslag'
                setNow('diuresisCalcTime');

                // Perform initial diuresis calculation
                calculateDiuresis();
            }
        };

        /**
         * Closes the Diuresis Calculator modal.
         */
        window.closeDiuresisCalculator = function() {
            console.log('Closing Diuresis Calculator modal.');
            const diuresisCalcModal = document.getElementById('diuresisCalculatorModalOverlay');
            if (diuresisCalcModal) {
                diuresisCalcModal.classList.remove('active');
                document.body.classList.remove('modal-open'); // Allow scrolling on main body
            }
        };

        /**
         * Calculates the diuresis needs based on inputs in the Diuresis Calculator.
         */
        function calculateDiuresis() {
            console.log('Calculating diuresis...');

            const desiredBalanceTomorrow = parseFloat(document.getElementById('desiredBalanceTomorrow')?.value || '0');
            const diuresisCalcTime = document.getElementById('diuresisCalcTime')?.value || '00:00';

            const plannedSingleIntake = parseFloat(document.getElementById('plannedSingleIntake')?.value || '0');
            const plannedHourlyIntake = parseFloat(document.getElementById('plannedHourlyIntake')?.value || '0');
            const plannedSingleLosses = parseFloat(document.getElementById('plannedSingleLosses')?.value || '0');

            // Calculate remaining time until 06:00 next day
            const tomorrow0600 = "06:00"; // Target end time for calculation
            const remainingHours = calculateDurationInHours(diuresisCalcTime, tomorrow0600);
            const remainingTimeTo0600Element = document.getElementById('remainingTimeTo0600');
            if (remainingTimeTo0600Element) remainingTimeTo0600Element.value = remainingHours.toFixed(1);

            // Calculate expected remaining perspiratio
            const expectedPerspiratioRemaining = calculatePerspiratio(remainingHours, appState.dailyWeight);
            const expectedPerspiratioRemainingElement = document.getElementById('expectedPerspiratioRemaining');
            if (expectedPerspiratioRemainingElement) expectedPerspiratioRemainingElement.value = expectedPerspiratioRemaining.toFixed(0);

            // --- Update Summary Table ---
            // Aktuella Värden (från Huvudflik)
            const summaryBalanceTillNowElement = document.getElementById('summaryBalanceTillNow');
            if (summaryBalanceTillNowElement) summaryBalanceTillNowElement.textContent = appState.netBalanceMl.toFixed(0);
            const summaryActualIntakeMainElement = document.getElementById('summaryActualIntakeMain');
            if (summaryActualIntakeMainElement) summaryActualIntakeMainElement.textContent = appState.totalIntakeMl.toFixed(0);
            const summaryActualLossExclDiuresisMainElement = document.getElementById('summaryActualLossExclDiuresisMain');
            if (summaryActualLossExclDiuresisMainElement) summaryActualLossExclDiuresisMainElement.textContent = appState.totalOtherLossMl.toFixed(0);
            const summaryActualDiuresisMainElement = document.getElementById('summaryActualDiuresisMain');
            if (summaryActualDiuresisMainElement) summaryActualDiuresisMainElement.textContent = appState.totalDiuresisMl.toFixed(0);
            const summaryActualPerspiratioMainElement = document.getElementById('summaryActualPerspiratioMain');
            if (summaryActualPerspiratioMainElement) summaryActualPerspiratioMainElement.textContent = appState.totalPerspiratioMl.toFixed(0);

            // Planerade Framtida Värden
            const summaryRemainingHoursFutureElement = document.getElementById('summaryRemainingHoursFuture');
            if (summaryRemainingHoursFutureElement) summaryRemainingHoursFutureElement.textContent = remainingHours.toFixed(1);
            const summaryPlannedSingleIntakeSummaryElement = document.getElementById('summaryPlannedSingleIntakeSummary');
            if (summaryPlannedSingleIntakeSummaryElement) summaryPlannedSingleIntakeSummaryElement.textContent = plannedSingleIntake.toFixed(0);
            const summaryPlannedHourlyIntakeSummaryElement = document.getElementById('summaryPlannedHourlyIntakeSummary');
            if (summaryPlannedHourlyIntakeSummaryElement) summaryPlannedHourlyIntakeSummaryElement.textContent = plannedHourlyIntake.toFixed(0);
            const summaryPlannedSingleLossesSummaryElement = document.getElementById('summaryPlannedSingleLossesSummary');
            if (summaryPlannedSingleLossesSummaryElement) summaryPlannedSingleLossesSummaryElement.textContent = plannedSingleLosses.toFixed(0);
            const summaryExpectedPerspiratioRemainingSummaryElement = document.getElementById('summaryExpectedPerspiratioRemainingSummary');
            if (summaryExpectedPerspiratioRemainingSummaryElement) summaryExpectedPerspiratioRemainingSummaryElement.textContent = expectedPerspiratioRemaining.toFixed(0);

            // Sammanställda Beräkningar & Diuresbehov
            const summaryDesiredBalanceTomorrowSummaryElement = document.getElementById('summaryDesiredBalanceTomorrowSummary');
            if (summaryDesiredBalanceTomorrowSummaryElement) summaryDesiredBalanceTomorrowSummaryElement.textContent = desiredBalanceTomorrow.toFixed(0);

            // Calculate total planned future intake
            const totalPlannedFutureIntake = plannedSingleIntake + (plannedHourlyIntake * remainingHours);
            // Calculate total planned future losses (excluding diuresis which is the goal)
            const totalPlannedFutureLossesExclDiuresis = plannedSingleLosses + expectedPerspiratioRemaining;

            // Total calculated intake (Main app intake + planned future intake)
            const summaryTotalCalculatedIntake = appState.totalIntakeMl + totalPlannedFutureIntake;
            const summaryTotalCalculatedIntakeElement = document.getElementById('summaryTotalCalculatedIntake');
            if (summaryTotalCalculatedIntakeElement) summaryTotalCalculatedIntakeElement.textContent = summaryTotalCalculatedIntake.toFixed(0);

            // Total calculated losses excluding diuresis (Main app losses excl. diuresis + planned future losses excl. diuresis)
            const summaryTotalCalculatedLossExclDiuresis = appState.totalOtherLossMl + appState.totalPerspiratioMl + totalPlannedFutureLossesExclDiuresis;
            const summaryTotalCalculatedLossExclDiuresisElement = document.getElementById('summaryTotalCalculatedLossExclDiuresis');
            if (summaryTotalCalculatedLossExclDiuresisElement) summaryTotalCalculatedLossExclDiuresisElement.textContent = summaryTotalCalculatedLossExclDiuresis.toFixed(0);


            // --- Final Diuresis Need Calculation ---
            // Logic: Desired Balance = (Current Net Balance from Main App) + (Total Calculated Intake) - (Total Calculated Losses excl. Diuresis) - (Diuresis Need)
            // Rearranged: Diuresis Need = (Current Net Balance from Main App) + (Total Calculated Intake) - (Total Calculated Losses excl. Diuresis) - Desired Balance
            // **Correction to the above comment and implementation based on typical fluid balance goals:**
            // The goal is to reach `desiredBalanceTomorrow` at 06:00 tomorrow.
            // Current Balance at 06:00 today (start of main app period) is `appState.cumulativeBalancePrev` + the current `netBalanceMl` from the main app's period.
            // Let's use `appState.netBalanceMl` (which is already `totalIntakeMl - totalLossMl` from the main app) as the *current fluid balance right now*.

            // So, from `appState.netBalanceMl` (current balance at main app's end time), we need to project forward.
            // Target = `desiredBalanceTomorrow`
            // Current state from main app: `appState.netBalanceMl`
            // Future fluid: `totalPlannedFutureIntake`
            // Future non-diuresis losses: `totalPlannedFutureLossesExclDiuresis`

            // So, `appState.netBalanceMl + totalPlannedFutureIntake - totalPlannedFutureLossesExclDiuresis - DiuresisNeeded = desiredBalanceTomorrow`
            // `DiuresisNeeded = appState.netBalanceMl + totalPlannedFutureIntake - totalPlannedFutureLossesExclDiuresis - desiredBalanceTomorrow`

            const requiredDiuresisForRemainingTime = appState.netBalanceMl + totalPlannedFutureIntake - totalPlannedFutureLossesExclDiuresis - desiredBalanceTomorrow;

            let diuresisNeedPerHour = 0;
            if (remainingHours > 0) {
                diuresisNeedPerHour = requiredDiuresisForRemainingTime / remainingHours;
            }
            const diuresisNeedPerHourElement = document.getElementById('diuresisNeedPerHour');
            if (diuresisNeedPerHourElement) diuresisNeedPerHourElement.textContent = diuresisNeedPerHour.toFixed(1);

            console.log('Diuresis Calculation Summary:', {
                desiredBalanceTomorrow,
                diuresisCalcTime,
                remainingHours,
                expectedPerspiratioRemaining,
                plannedSingleIntake,
                plannedHourlyIntake,
                plannedSingleLosses,
                summaryBalanceTillNow: appState.netBalanceMl,
                summaryActualIntakeMain: appState.totalIntakeMl,
                summaryActualLossExclDiuresisMain: appState.totalOtherLossMl,
                summaryActualDiuresisMain: appState.totalDiuresisMl,
                summaryActualPerspiratioMain: appState.totalPerspiratioMl,
                totalPlannedFutureIntake,
                totalPlannedFutureLossesExclDiuresis,
                summaryTotalCalculatedIntake,
                summaryTotalCalculatedLossExclDiuresis,
                requiredDiuresisForRemainingTime,
                diuresisNeedPerHour
            });
        }

        // --- New functions for Detailed Summary Modal ---
        /**
         * Opens the Detailed Summary Modal and populates it with current data.
         */
        window.openPrintSummaryModal = function() {
            console.log('Opening Detailed Summary modal.');
            const modalOverlay = document.getElementById('printDetailedSummaryModalOverlay');
            if (modalOverlay) {
                // Ensure all calculations are up-to-date before populating
                calculateTotals();

                // Populate general info
                document.getElementById('summaryDate').textContent = appState.patientDate;
                document.getElementById('summaryTimePeriod').textContent = appState.patientTimePeriod;
                document.getElementById('summaryLocation').textContent = appState.patientLocation;

                // Populate weights
                document.getElementById('printInitialWeight').textContent = appState.initialWeight.toFixed(1) + ' kg';
                document.getElementById('printDailyWeight').textContent = appState.dailyWeight.toFixed(1) + ' kg';
                document.getElementById('printIdealWeight').textContent = appState.idealWeight.toFixed(1) + ' kg' + (appState.adjustedWeight ? ' (Justerad)' : '');
                document.getElementById('printWeightDifference').textContent = appState.weightDifferenceKg.toFixed(1) + ' kg';

                // Populate fluid balance
                document.getElementById('printTotalIntakeMl').textContent = Math.round(appState.totalIntakeMl) + ' ml';
                document.getElementById('printTotalLossMl').textContent = Math.round(appState.totalLossMl) + ' ml';
                document.getElementById('printNetBalanceMl').textContent = Math.round(appState.netBalanceMl) + ' ml';
                document.getElementById('printCumulativeBalanceMl').textContent = Math.round(appState.cumulativeBalanceMl) + ' ml';

                // Populate medicine volumes by category
                document.getElementById('printMedicineSedativeMl').textContent = Math.round(appState.medicineCategoryTotals.Sedering) + ' ml';
                document.getElementById('printMedicineAntibioticsMl').textContent = Math.round(appState.medicineCategoryTotals.Antibiotika) + ' ml';
                document.getElementById('printMedicineVasoactiveMl').textContent = Math.round(appState.medicineCategoryTotals.Vasoaktiva) + ' ml';
                document.getElementById('printMedicineOtherMl').textContent = Math.round(appState.medicineCategoryTotals.Övrigt) + ' ml';

                // Populate Kcal intake by source
                document.getElementById('printKcalPeroral').textContent = Math.round(appState.kcalSummary.peroralt) + ' Kcal';
                document.getElementById('printKcalSondmat').textContent = Math.round(appState.kcalSummary.sondmat) + ' Kcal';
                // Populate the new combined Kcal line
                document.getElementById('printKcalIntravenousTotal').textContent = Math.round(appState.kcalSummary.intravenousTotal) + ' Kcal';
                document.getElementById('printTotalKcalIntake').textContent = Math.round(appState.totalIntakeKcal) + ' Kcal';


                modalOverlay.classList.add('active');
                document.body.classList.add('modal-open'); // Prevent scrolling on main body
            }
        };

        /**
         * Closes the Detailed Summary Modal.
         */
        window.closePrintSummaryModal = function() {
            console.log('Closing Detailed Summary modal.');
            const modalOverlay = document.getElementById('printDetailedSummaryModalOverlay');
            if (modalOverlay) {
                modalOverlay.classList.remove('active');
                document.body.classList.remove('modal-open'); // Allow scrolling on main body
            }
        };

        /**
         * Triggers the print functionality for the detailed summary content.
         */
        window.printSummaryContent = function() {
            console.log('Print Summary Content function called. Initiating print...');
            window.print();
        };


        // Waits until the entire DOM tree has loaded before running the script
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Sets yesterday's date as default in the date field
                const dateInput = document.getElementById('dateInput');
                if (dateInput) {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    dateInput.value = yesterday.toISOString().split('T')[0];
                }

                // Logic to show/hide the "Other location" field based on selection in the "Bed" menu
                const bedSelect = document.getElementById('bedSelect');
                const otherLocationInput = document.getElementById('otherLocationInput');
                if (bedSelect && otherLocationInput) {
                    bedSelect.addEventListener('change', function() {
                        console.log("Bed select changed.");
                        if (bedSelect.value === 'Annan plats') {
                            otherLocationInput.style.display = 'block';
                            otherLocationInput.setAttribute('required', 'true');
                        } else {
                            otherLocationInput.style.display = 'none';
                            otherLocationInput.removeAttribute('required');
                            otherLocationInput.value = '';
                        }
                        calculateTotals();
                    });
                }

                // Handles visual feedback for "important" input fields (weight, height, gender)
                const importantInputs = document.querySelectorAll('.important-input');
                importantInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        console.log(`Important input ${this.id} changed.`);
                        if (this.value.trim() !== '' && (this.type !== 'number' || !isNaN(parseFloat(this.value)))) {
                            this.classList.remove('important-input');
                            this.classList.add('filled-input');
                        } else {
                            this.classList.remove('filled-input');
                            this.classList.add('important-input');
                        }
                        calculateTotals();
                    });
                    // Initial check for already filled inputs
                    if (input.value.trim() !== '' && (input.type !== 'number' || !isNaN(parseFloat(input.value)))) {
                        input.classList.remove('important-input');
                        input.classList.add('filled-input');
                    }
                });

                // Synchronizes values for "Daily weight", "Height", and "Gender" with ideal weight calculation and total calculation.
                const dailyWeightInput = document.getElementById('dailyWeight');
                const heightInput = document.getElementById('height');
                const genderSelect = document.getElementById('gender');
                const idealWeightInput = document.getElementById('idealWeight');
                const adjustedWeightNotice = document.getElementById('adjustedWeightNotice');

                // Function to calculate ideal weight and adjusted ideal weight
                function calculateIdealAndAdjustedWeight() {
                    if (!heightInput || !genderSelect || !dailyWeightInput || !idealWeightInput || !adjustedWeightNotice) {
                        console.warn("Missing elements for ideal weight calculation.");
                        return;
                    }
                    const heightCm = parseFloat(heightInput.value);
                    const gender = genderSelect.value;
                    const dailyWeight = parseFloat(dailyWeightInput.value);

                    if (isNaN(heightCm) || heightCm <= 0 || gender === '') {
                        idealWeightInput.value = "Var god ange längd och kön";
                        idealWeightInput.readOnly = true;
                        adjustedWeightNotice.style.display = 'none';
                        return;
                    }

                    idealWeightInput.readOnly = false;

                    let idealWeight;
                    // Devine formula (metric conversion)
                    if (gender === 'Man') {
                        idealWeight = 50 + 0.91 * (heightCm - 152.4);
                    } else if (gender === 'Kvinna') {
                        idealWeight = 45.5 + 0.91 * (heightCm - 152.4);
                    } else {
                        idealWeightInput.value = "Var god ange längd och kön";
                        idealWeightInput.readOnly = true;
                        adjustedWeightNotice.style.display = 'none';
                        return;
                    }

                    idealWeight = Math.round(idealWeight * 10) / 10;

                    let displayWeight = idealWeight;
                    let isAdjusted = false;

                    // Check for adjusted body weight (if actual weight is > 120% of ideal weight)
                    if (!isNaN(dailyWeight) && dailyWeight > (idealWeight * 1.20)) {
                        displayWeight = idealWeight + 0.4 * (dailyWeight - idealWeight);
                        displayWeight = Math.round(displayWeight * 10) / 10;
                        isAdjusted = true;
                    }

                    idealWeightInput.value = displayWeight.toFixed(1);
                    adjustedWeightNotice.style.display = isAdjusted ? 'inline' : 'none';

                    // No direct call to calculateTotals() here. It will be called explicitly after all initial setups.
                }

                if (dailyWeightInput) {
                    dailyWeightInput.addEventListener('input', function() {
                        calculateIdealAndAdjustedWeight();
                        calculatePerspiratio();
                        calculateTotals(); // Call calculateTotals here
                    });
                }
                if (heightInput) heightInput.addEventListener('input', function() {
                    calculateIdealAndAdjustedWeight();
                    calculatePerspiratio();
                    calculateTotals(); // Call calculateTotals here
                });
                if (genderSelect) genderSelect.addEventListener('change', function() {
                    calculateIdealAndAdjustedWeight();
                    calculatePerspiratio();
                    calculateTotals(); // Call calculateTotals here
                });
                calculateIdealAndAdjustedWeight(); // Initial call

                // Adds event listeners for all other relevant input fields to call calculateTotals()
                const otherInputs = document.querySelectorAll(
                    '#dateInput, #cumulativeBalancePrev, #naclSyringes, #pressureSets'
                );
                otherInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        console.log(`Other input ${this.id} changed.`);
                        calculateTotals();
                    });
                     // Add an input event listener for immediate updates on naclSyringes and pressureSets
                    if (input.id === 'naclSyringes' || input.id === 'pressureSets') {
                        input.addEventListener('input', calculateTotals);
                    }
                });


                // --- Initial population of static select elements ---
                if (document.getElementById('fluidSelect_1')) populateFluidSelect(document.getElementById('fluidSelect_1'));
                if (document.getElementById('medicineSelect_med_1')) populateMedicineSelect(document.getElementById('medicineSelect_med_1'));
                if (document.getElementById('bloodProductSelect_blood_1')) populateBloodProductSelect(document.getElementById('bloodProductSelect_blood_1'));
                if (document.getElementById('tpnSondmatSelect_tpn_1')) populateTpnSondmatSelect(document.getElementById('tpnSondmatSelect_tpn_1'));
                if (document.getElementById('lossSelect_loss_1')) populateLossSelect(document.getElementById('lossSelect_loss_1'));


                // Set up event listeners for the *initial* fluid row
                const initialFluidSelect = document.getElementById('fluidSelect_1');
                const initialMlInput = document.getElementById('mlInput_1');
                const initialKcalOutput = document.getElementById('kcalOutput_1');
                const initialCustomFluidInput = document.getElementById('customFluidInput_1');
                const initialRemoveButton = document.querySelector('.fluid-entry-row[data-row-id="1"] .remove-fluid-button');

                if (initialFluidSelect && initialMlInput && initialKcalOutput) {
                    initialFluidSelect.addEventListener('change', () => {
                        console.log(`Initial fluid select ${initialFluidSelect.id} changed.`);
                        if (initialCustomFluidInput) {
                            if (initialFluidSelect.value === 'Övrig vätska') {
                                initialCustomFluidInput.style.display = 'block';
                                initialCustomFluidInput.focus();
                            } else {
                                initialCustomFluidInput.style.display = 'none';
                                initialCustomFluidInput.value = '';
                            }
                        }
                        calculateKcalForEntry(1);
                    });
                    initialMlInput.addEventListener('input', () => {
                        console.log(`Initial fluid ML input ${initialMlInput.id} changed.`);
                        calculateKcalForEntry(1);
                    });
                    if (initialCustomFluidInput) {
                        initialCustomFluidInput.addEventListener('input', () => {
                            console.log(`Initial custom fluid input ${initialCustomFluidInput.id} changed.`);
                            calculateTotals();
                        });
                    }
                    initialKcalOutput.addEventListener('input', () => {
                        console.log(`Initial Kcal output ${initialKcalOutput.id} changed.`);
                        initialKcalOutput.dataset.manualOverride = 'true';
                        calculateTotals();
                    });
                    if (initialRemoveButton) {
                        initialRemoveButton.addEventListener('click', function() {
                            console.log(`Remove initial fluid button ${this.dataset.rowId} clicked.`);
                            const rowToRemove = document.querySelector('.fluid-entry-row[data-row-id="1"]');
                            if (rowToRemove) {
                                rowToRemove.remove();
                                calculateTotals();
                            }
                        });
                    }
                    calculateKcalForEntry(1);
                }


                // --- Handling for Crystalloids/Colloids fluid rows ---
                const fluidEntriesContainer = document.getElementById('fluidEntriesContainer');
                const addFluidButton = document.getElementById('addFluidButton');
                if (addFluidButton) {
                    addFluidButton.addEventListener('click', () => {
                        console.log('Add Fluid button clicked.');
                        createFluidEntryRow();
                    });
                }

                // Set up event listeners for the *initial* medicine row
                const initialMedicineSelect = document.getElementById('medicineSelect_med_1');
                const initialMedicineMlInput = document.getElementById('medicineMlInput_med_1');
                const initialMedicineKcalOutput = document.getElementById('medicineKcalOutput_med_1');
                const initialCustomMedicineInput = document.getElementById('customMedicineInput_med_1');
                const initialRemoveMedicineButton = document.querySelector('.fluid-entry-row[data-row-id="med_1"] .remove-fluid-button');

                if (initialMedicineSelect && initialMedicineMlInput && initialMedicineKcalOutput) {
                    initialMedicineSelect.addEventListener('change', () => {
                        console.log(`Initial medicine select ${initialMedicineSelect.id} changed.`);
                        const selectedOption = initialMedicineSelect.options[initialMedicineSelect.selectedIndex];
                        const defaultMl = parseFloat(selectedOption.dataset.defaultMl || '0');
                        if (defaultMl > 0) {
                            initialMedicineMlInput.value = defaultMl;
                        } else if (initialMedicineMlInput.value !== '0' && initialMedicineMlInput.value !== '') {
                        } else {
                            initialMedicineMlInput.value = 0;
                        }

                        if (initialCustomMedicineInput) {
                            if (initialMedicineSelect.value === 'Övrigt läkemedel' || initialMedicineSelect.value === 'Övrig Antibiotika') {
                                initialCustomMedicineInput.style.display = 'block';
                                initialCustomMedicineInput.focus();
                                initialCustomMedicineInput.placeholder = (initialMedicineSelect.value === 'Övrig Antibiotika') ? 'Ange övrig antibiotika' : 'Ange övrigt läkemedel';
                            } else {
                                initialCustomMedicineInput.style.display = 'none';
                                initialCustomMedicineInput.value = '';
                            }
                        }
                        calculateKcalForMedicineEntry('med_1');
                    });
                    initialMedicineMlInput.addEventListener('input', () => {
                        console.log(`Initial medicine ML input ${initialMedicineMlInput.id} changed.`);
                        calculateKcalForMedicineEntry('med_1');
                    });
                    if (initialCustomMedicineInput) {
                        initialCustomMedicineInput.addEventListener('input', () => {
                            console.log(`Initial custom medicine input ${initialCustomMedicineInput.id} changed.`);
                            calculateTotals();
                        });
                    }
                    initialMedicineKcalOutput.addEventListener('input', () => {
                        console.log(`Initial Kcal output ${initialMedicineKcalOutput.id} changed.`);
                        initialMedicineKcalOutput.dataset.manualOverride = 'true';
                        calculateTotals();
                    });
                    if (initialRemoveMedicineButton) {
                        initialRemoveMedicineButton.addEventListener('click', function() {
                            console.log(`Remove initial medicine button ${this.dataset.rowId} clicked.`);
                            const rowToRemove = document.querySelector('.fluid-entry-row[data-row-id="med_1"]');
                            if (rowToRemove) {
                                rowToRemove.remove();
                                calculateTotals();
                            }
                        });
                    }
                    calculateKcalForMedicineEntry('med_1');
                }

                const medicineEntriesContainer = document.getElementById('medicineEntriesContainer');
                const addMedicineButton = document.getElementById('addMedicineButton');
                if (addMedicineButton) {
                    addMedicineButton.addEventListener('click', () => {
                        console.log('Add Medicine button clicked.');
                        createMedicineEntryRow();
                    });
                }

                // Set up event listeners for the *initial* blood product row
                const initialBloodProductSelect = document.getElementById('bloodProductSelect_blood_1');
                const initialBloodProductMlInput = document.getElementById('bloodProductMlInput_blood_1');
                const initialRemoveBloodProductButton = document.querySelector('.blood-product-entry-row[data-row-id="blood_1"] .remove-fluid-button');

                if (initialBloodProductSelect && initialBloodProductMlInput) {
                    initialBloodProductSelect.addEventListener('change', () => {
                        console.log(`Initial blood product select ${initialBloodProductSelect.id} changed.`);
                        calculateTotals();
                    });
                    initialBloodProductMlInput.addEventListener('input', () => {
                        console.log(`Initial blood product ML input ${initialBloodProductMlInput.id} changed.`);
                        calculateTotals();
                    });
                    if (initialRemoveBloodProductButton) {
                        initialRemoveBloodProductButton.addEventListener('click', function() {
                            console.log(`Remove initial blood product button ${this.dataset.rowId} clicked.`);
                            const rowToRemove = document.querySelector('.blood-product-entry-row[data-row-id="blood_1"]');
                            if (rowToRemove) {
                                rowToRemove.remove();
                                calculateTotals();
                            }
                        });
                    }
                    calculateTotals(); // Initial calculation for blood products
                }

                const bloodProductEntriesContainer = document.getElementById('bloodProductEntriesContainer');
                const addBloodProductButton = document.getElementById('addBloodProductButton');
                if (addBloodProductButton) {
                    addBloodProductButton.addEventListener('click', () => {
                        console.log('Add Blood Product button clicked.');
                        createBloodProductEntryRow();
                    });
                }

                // Set up event listeners for the *initial* TPN/Sondmat row
                const initialTpnSondmatSelect = document.getElementById('tpnSondmatSelect_tpn_1');
                const initialTpnSondmatMlInput = document.getElementById('tpnSondmatMlInput_tpn_1');
                const initialTpnSondmatKcalOutput = document.getElementById('tpnSondmatKcalOutput_tpn_1');
                const initialCustomTpnSondmatInput = document.getElementById('customTpnSondmatInput_tpn_1');
                const initialRemoveTpnSondmatButton = document.querySelector('.tpn-sondmat-entry-row[data-row-id="tpn_1"] .remove-fluid-button');

                if (initialTpnSondmatSelect && initialTpnSondmatMlInput && initialTpnSondmatKcalOutput) {
                    initialTpnSondmatSelect.addEventListener('change', () => {
                        console.log(`Initial TPN/Sondmat select ${initialTpnSondmatSelect.id} changed.`);
                        if (initialCustomTpnSondmatInput) {
                            // ONLY show custom input for 'Sondmat övrig'
                            if (initialTpnSondmatSelect.value === 'Sondmat övrig') {
                                initialCustomTpnSondmatInput.style.display = 'block';
                                initialCustomTpnSondmatInput.focus();
                                initialCustomTpnSondmatInput.placeholder = 'Ange övrig sondmat';
                            } else {
                                initialCustomTpnSondmatInput.style.display = 'none';
                                initialCustomTpnSondmatInput.value = '';
                            }
                        }
                        calculateKcalForTpnSondmatEntry('tpn_1');
                    });
                    initialTpnSondmatMlInput.addEventListener('input', () => {
                        console.log(`Initial TPN/Sondmat ML input ${initialTpnSondmatMlInput.id} changed.`);
                        calculateKcalForTpnSondmatEntry('tpn_1');
                    });
                    if (initialCustomTpnSondmatInput) {
                        initialCustomTpnSondmatInput.addEventListener('input', () => {
                            console.log(`Initial custom TPN/Sondmat input ${initialCustomTpnSondmatInput.id} changed.`);
                            calculateTotals();
                        });
                    }
                    initialTpnSondmatKcalOutput.addEventListener('input', () => {
                        console.log(`Initial TPN/SSondmat Kcal output ${initialTpnSondmatKcalOutput.id} changed.`);
                        initialTpnSondmatKcalOutput.dataset.manualOverride = 'true';
                        calculateTotals();
                    });
                    if (initialRemoveTpnSondmatButton) {
                        initialRemoveTpnSondmatButton.addEventListener('click', function() {
                            console.log(`Remove initial TPN/Sondmat button ${this.dataset.rowId} clicked.`);
                            const rowToRemove = document.querySelector('.tpn-sondmat-entry-row[data-row-id="tpn_1"]');
                            if (rowToRemove) {
                                rowToRemove.remove();
                                calculateTotals();
                            }
                        });
                    }
                    calculateKcalForTpnSondmatEntry('tpn_1');
                }

                const tpnSondmatEntriesContainer = document.getElementById('tpnSondmatEntriesContainer');
                const addTpnSondmatButton = document.getElementById('addTpnSondmatButton');
                if (addTpnSondmatButton) {
                    addTpnSondmatButton.addEventListener('click', () => {
                        console.log('Add TPN/Sondmat button clicked.');
                        createTpnSondmatEntryRow();
                    });
                }

                // Set up event listeners for the *initial* loss row (excluding static perspiratio)
                const initialLossSelect = document.getElementById('lossSelect_loss_1');
                const initialLossMlInput = document.getElementById('lossMlInput_loss_1');
                const initialCustomLossInput = document.getElementById('customLossInput_loss_1');
                const initialRemoveLossButton = document.querySelector('.loss-entry-row[data-row-id="loss_1"] .remove-fluid-button');

                if (initialLossSelect && initialLossMlInput) {
                    initialLossSelect.addEventListener('change', () => {
                        console.log(`Initial loss select ${initialLossSelect.id} changed.`);
                        if (initialCustomLossInput) {
                            if (initialLossSelect.value === 'Annan förlust') {
                                initialCustomLossInput.style.display = 'block';
                                initialCustomLossInput.focus();
                            } else {
                                initialCustomLossInput.style.display = 'none';
                                initialCustomLossInput.value = '';
                            }
                        }
                        calculateTotals();
                    });
                    initialLossMlInput.addEventListener('input', () => {
                        console.log(`Initial loss ML input ${initialLossMlInput.id} changed.`);
                        calculateTotals();
                    });
                    if (initialCustomLossInput) {
                        initialCustomLossInput.addEventListener('input', () => {
                            console.log(`Initial custom loss input ${initialCustomLossInput.id} changed.`);
                            calculateTotals();
                        });
                    }
                    if (initialRemoveLossButton) {
                        initialRemoveLossButton.addEventListener('click', function() {
                            console.log(`Remove initial loss button ${this.dataset.rowId} clicked.`);
                            const rowToRemove = document.querySelector('.loss-entry-row[data-row-id="loss_1"]');
                            if (rowToRemove) {
                                rowToRemove.remove();
                                calculateTotals();
                            }
                        });
                    }
                    calculateTotals(); // Initial calculation for losses
                }

                // Event listener for the static Perspiratio loss row
                const staticPerspiratioMlInput = document.getElementById('lossMlInput_perspiratio_static');
                if (staticPerspiratioMlInput) {
                    staticPerspiratioMlInput.addEventListener('input', () => {
                        console.log(`Static Perspiratio ML input ${staticPerspiratioMlInput.id} changed.`);
                        calculateTotals();
                    });
                }


                const lossEntriesContainer = document.getElementById('lossEntriesContainer');
                const addLossButton = document.getElementById('addLossButton');
                if (addLossButton) {
                    addLossButton.addEventListener('click', () => {
                        console.log('Add Loss button clicked.');
                        createLossEntryRow();
                    });
                }

                // Event listeners for temperature inputs
                const tempInputs = document.querySelectorAll('#temp37Hours, #temp38Hours, #temp39Hours, #temp40Hours');
                tempInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        console.log(`Temperature input ${input.id} changed.`);
                        calculatePerspiratio();
                    });
                });

                // Event listeners for breathing support select
                const breathingSupportSelect = document.getElementById('breathingSupport');
                if (breathingSupportSelect) {
                    breathingSupportSelect.addEventListener('change', () => {
                        console.log(`Breathing support select ${breathingSupportSelect.id} changed.`);
                        calculatePerspiratio();
                    });
                }

                // Event listeners for start and end times to trigger perspiratio calculation
                const startTimeInput = document.getElementById('startTime');
                const endTimeInput = document.getElementById('endTime');
                if (startTimeInput) {
                    startTimeInput.addEventListener('input', () => {
                        console.log(`Start time input ${startTimeInput.id} changed.`);
                        appState.mainAppStartTime = startTimeInput.value; // Update appState
                        calculatePerspiratio();
                    });
                }
                if (endTimeInput) {
                    endTimeInput.addEventListener('input', () => {
                        console.log(`End time input ${endTimeInput.id} changed.`);
                        appState.mainAppEndTime = endTimeInput.value; // Update appState
                        calculatePerspiratio();
                    });
                }

                // Open Calculations Modal Button
                const openCalculationsButton = document.getElementById('openCalculationsButton');
                if (openCalculationsButton) {
                    openCalculationsButton.addEventListener('click', () => {
                        console.log('Open Calculations button clicked.');
                        populateKcalTableInModal(); // Populate tables before opening
                        document.getElementById('calculationsModalOverlay').classList.add('active');
                        document.body.classList.add('modal-open');
                    });
                }

                // Diuresis Calculator Button
                const openDiuresisCalculatorButton = document.getElementById('openDiuresisCalculatorButton');
                if (openDiuresisCalculatorButton) {
                    openDiuresisCalculatorButton.addEventListener('click', openDiuresisCalculator);
                }

                // Diuresis Calculator input listeners
                const diuresisCalcInputs = document.querySelectorAll(
                    '#desiredBalanceTomorrow, #diuresisCalcTime, #plannedSingleIntake, #plannedHourlyIntake, #plannedSingleLosses'
                );
                diuresisCalcInputs.forEach(input => {
                    input.addEventListener('input', calculateDiuresis);
                });


                // Print Detailed Summary Button
                const openPrintSummaryButton = document.getElementById('openPrintSummaryButton');
                if (openPrintSummaryButton) {
                    openPrintSummaryButton.addEventListener('click', openPrintSummaryModal);
                }

                // Initial calculation calls after all elements are loaded and listeners set up
                calculateTotals();
                calculatePerspiratio();
            } catch (error) {
                console.error("Error during DOMContentLoaded:", error);
            }
        });
    </script>
</body>
</html>
